#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
RRD Viewer with Briefing - Modern UI Version

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” rerun ë·°ì–´ë¡œ RRD íŒŒì¼ì„ ì—´ê³  3D ì¥ë©´ ë ˆì´ì•„ì›ƒê³¼ ê´€ë ¨ëœ
ë¸Œë¦¬í•‘ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” í˜„ëŒ€ì ì¸ UI íŒì—… ì°½ì„ í‘œì‹œí•©ë‹ˆë‹¤.

Usage:
    python qt_rerun_briefing.py -i scene0002_00.rrd [options]
"""

import os
import sys
import locale
import argparse
import tempfile
import subprocess
import threading
import time
import shutil
import platform
import json
import markdown
from pathlib import Path
import requests
import configparser
from datetime import datetime
import random
import codecs
import torch
from transformers import AutoTokenizer, AutoModelForCausalLM
from spatiallm.layout.layout import Layout
import webbrowser

try:
    from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                                 QHBoxLayout, QLabel, QTextEdit, QPushButton, 
                                 QSplitter, QFrame, QMessageBox, QComboBox,
                                 QProgressBar, QToolBar, QAction, QFileDialog,
                                 QSizePolicy, QSpacerItem, QGraphicsDropShadowEffect,
                                 QStatusBar, QDialog, QLineEdit, QFormLayout)
    from PyQt5.QtGui import QFont, QIcon, QTextCursor, QColor, QPalette, QFontDatabase, QPixmap, QTextDocument, QPainter, QBrush, QPen
    from PyQt5.QtCore import Qt, QThread, pyqtSignal, QUrl, QSize, QTimer
except ImportError:
    print("PyQt5 ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”:")
    print("pip install PyQt5")
    sys.exit(1)

try:
    import markdown
except ImportError:
    print("Python-Markdown ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”:")
    print("pip install markdown")
    sys.exit(1)

# ì‹œìŠ¤í…œ ê¸°ë³¸ ì¸ì½”ë”© í™•ì¸ ë° ì„¤ì •
print(f"Current locale: {locale.getdefaultlocale()}")
print(f"Current file system encoding: {sys.getfilesystemencoding()}")
print(f"Current default encoding: {sys.getdefaultencoding()}")

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í•œê¸€ ì²˜ë¦¬)
os.environ["PYTHONIOENCODING"] = "utf-8"
os.environ["LANG"] = "ko_KR.UTF-8"

# layout_based_briefing.pyì—ì„œ í•„ìš”í•œ í•¨ìˆ˜ë“¤ í†µí•©
def load_layout_from_file(layout_file):
    """
    Load a layout from a file generated by inference.py
    
    Args:
        layout_file (str): Path to the layout file
        
    Returns:
        layout (Layout): The layout object
    """
    try:
        with open(layout_file, 'r', encoding='utf-8') as f:
            layout_str = f.read()
        
        # Create Layout object from the layout string
        layout = Layout(layout_str)
        return layout
    except Exception as e:
        print(f"Error loading layout from file: {str(e)}")
        raise

def analyze_layout(layout):
    """
    Analyze a layout to extract key information
    
    Args:
        layout (Layout): The layout object
        
    Returns:
        dict: Dictionary containing analysis results
    """
    # Get layout string
    layout_str = layout.to_language_string()
    layout_lines = layout_str.strip().split('\n')
    
    # Categorize entities by parsing the layout string
    walls = []
    doors = []
    windows = []
    objects = []
    
    for line in layout_lines:
        if line.startswith('wall_') or 'Wall(' in line:
            walls.append(line)
        elif line.startswith('door_') or 'Door(' in line:
            doors.append(line)
        elif line.startswith('window_') or 'Window(' in line:
            windows.append(line)
        elif line.startswith('bbox_') or 'Bbox(' in line:
            objects.append(line)
    
    # Count object types
    object_types = {}
    for obj in objects:
        try:
            if "=" in obj and "(" in obj:
                # Format like: bbox_0=Bbox(sofa,-3.5064208984375,0.9839955329895016,...)
                obj_type = obj.split('(')[1].split(',')[0]
            else:
                # Other format
                parts = obj.split(',')
                obj_type = parts[0]
                
            if obj_type in object_types:
                object_types[obj_type] += 1
            else:
                object_types[obj_type] = 1
        except Exception as e:
            print(f"Failed to parse object: {obj}, error: {e}")
            continue
    
    # Calculate approximate room dimensions
    x_coords = []
    y_coords = []
    heights = []
    
    for wall in walls:
        try:
            # Try to extract coordinates based on the format
            if "Wall(" in wall:
                # Format: wall_0=Wall(-3.15,-4.01,0.02,-0.95,-4.01,0.02,2.72,0.0)
                coords = wall.split('(')[1].split(')')[0].split(',')
                x_coords.extend([float(coords[0]), float(coords[3])])
                y_coords.extend([float(coords[1]), float(coords[4])])
                if len(coords) > 6:
                    heights.append(float(coords[6]))
        except Exception as e:
            print(f"Failed to parse wall coordinates: {wall}, error: {e}")
            continue
    
    # Calculate dimensions if we have coordinates
    if x_coords and y_coords:
        width = max(x_coords) - min(x_coords)
        length = max(y_coords) - min(y_coords)
        height = max(heights) if heights else 2.4  # Default height if not available
        area = width * length
        volume = area * height
    else:
        width = length = height = area = volume = 0
    
    # Infer room type
    room_type = "Unknown"
    if object_types:
        if any(obj_type in ['bed', 'pillow', 'nightstand'] for obj_type in object_types):
            room_type = "Bedroom"
        elif any(obj_type in ['sofa', 'tv', 'coffee_table', 'couch'] for obj_type in object_types):
            room_type = "Living Room"
        elif any(obj_type in ['dining_table', 'chair', 'dining_table_combination'] for obj_type in object_types):
            room_type = "Dining Room"
        elif any(obj_type in ['toilet', 'sink', 'bathtub', 'shower'] for obj_type in object_types):
            room_type = "Bathroom"
        elif any(obj_type in ['stove', 'refrigerator', 'oven', 'microwave'] for obj_type in object_types):
            room_type = "Kitchen"
    
    return {
        "wall_count": len(walls),
        "door_count": len(doors),
        "window_count": len(windows),
        "object_count": len(objects),
        "object_types": object_types,
        "width": width,
        "length": length,
        "height": height,
        "area": area,
        "volume": volume,
        "room_type": room_type
    }

class RerunViewerThread(QThread):
    """
    Rerun ë·°ì–´ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ
    """
    error_signal = pyqtSignal(str)

    def __init__(self, rrd_file):
        QThread.__init__(self)
        self.rrd_file = rrd_file

    def run(self):
        try:
            # Rerun ë·°ì–´ ì‹¤í–‰
            subprocess.Popen(["rerun", self.rrd_file])
        except Exception as e:
            self.error_signal.emit(f"Rerun ë·°ì–´ ì‹¤í–‰ ì˜¤ë¥˜: {str(e)}")

class CodeExecutionThread(QThread):
    """
    ìƒì„±ëœ Python ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ
    """
    execution_completed = pyqtSignal(bool, str, str)  # ì„±ê³µ ì—¬ë¶€, ê²°ê³¼ ë©”ì‹œì§€, ê²°ê³¼ íŒŒì¼ ê²½ë¡œ
    
    def __init__(self, code, tmp_dir=None):
        QThread.__init__(self)
        self.code = code
        self.tmp_dir = tmp_dir or tempfile.mkdtemp(prefix="spatialLM_code_")
        self.code_file = os.path.join(self.tmp_dir, "generated_code.py")
        
    def run(self):
        try:
            # ì½”ë“œë¥¼ ì„ì‹œ íŒŒì¼ì— ì €ì¥
            with open(self.code_file, 'w', encoding='utf-8') as f:
                f.write(self.code)
            
            # ê°„ë‹¨í•˜ê²Œ python ëª…ë ¹ì–´ë§Œ ì‚¬ìš©
            if platform.system() == "Windows":
                cmd = f"python {self.code_file}"
            else:
                cmd = f"python {self.code_file}"
            
            # ì‹¤í–‰
            process = subprocess.Popen(
                cmd, 
                shell=True, 
                stdout=subprocess.PIPE, 
                stderr=subprocess.PIPE,
                cwd=self.tmp_dir
            )
            
            # ì¶œë ¥ ìº¡ì²˜
            stdout, stderr = process.communicate(timeout=60)  # 60ì´ˆ íƒ€ì„ì•„ì›ƒ
            
            # ê²°ê³¼ í™•ì¸
            if process.returncode == 0:
                # ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë¨ - ìƒì„±ëœ íŒŒì¼ ì°¾ê¸°
                result_files = []
                for file in os.listdir(self.tmp_dir):
                    if file != "generated_code.py" and file.endswith(('.png', '.jpg', '.jpeg', '.html', '.svg', '.pdf')):
                        result_files.append(os.path.join(self.tmp_dir, file))
                
                if result_files:
                    # ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë¨
                    result_file = result_files[0]  # ì²« ë²ˆì§¸ íŒŒì¼ ì‚¬ìš©
                    success_msg = f"ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ íŒŒì¼: {os.path.basename(result_file)}"
                    self.execution_completed.emit(True, success_msg, result_file)
                else:
                    # ê²°ê³¼ íŒŒì¼ì´ ì—†ìŒ
                    stdout_text = stdout.decode('utf-8', errors='replace')
                    self.execution_completed.emit(True, f"ì½”ë“œëŠ” ì‹¤í–‰ë˜ì—ˆì§€ë§Œ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¶œë ¥:\n{stdout_text}", "")
            else:
                # ì‹¤í–‰ ì˜¤ë¥˜
                stderr_text = stderr.decode('utf-8', errors='replace')
                self.execution_completed.emit(False, f"ì½”ë“œ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{stderr_text}", "")
        
        except Exception as e:
            self.execution_completed.emit(False, f"ì½”ë“œ ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤ ì˜¤ë¥˜: {str(e)}", "")

class QAThread(QThread):
    """
    ì§ˆë¬¸-ë‹µë³€ ìƒì„±ì„ ìœ„í•œ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ (ChatGPT API ì‚¬ìš©)
    """
    answer_signal = pyqtSignal(str)
    error_signal = pyqtSignal(str)
    stream_signal = pyqtSignal(str)  # ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ì„ ìœ„í•œ ì‹œê·¸ë„ ì¶”ê°€
    code_generated_signal = pyqtSignal(str)  # ì½”ë“œ ìƒì„± ì‹œê·¸ë„ ì¶”ê°€
    
    def __init__(self, layout_file, briefing_content, question, api_key, model="gpt-4", language="korean"):
        QThread.__init__(self)
        self.layout_file = layout_file
        self.briefing_content = briefing_content
        self.question = question
        self.api_key = api_key
        self.model = model
        self.language = language
        
    def run(self):
        """
        QA ìŠ¤ë ˆë“œ ì‹¤í–‰ - ë ˆì´ì•„ì›ƒ ë° ë¸Œë¦¬í•‘ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸-ë‹µë³€ ìƒì„±
        
        íŠ¹ë³„ í‚¤ì›Œë“œ "IIFA" ì‚¬ìš©ë²•:
        - ë©”ì‹œì§€ ì‹œì‘ ë˜ëŠ” ëì— "IIFA"ë¥¼ ì¶”ê°€í•˜ë©´ ì‹œê°í™”/ì½”ë“œ ìƒì„± ëª¨ë“œ í™œì„±í™”
        - ê·¸ ì™¸ì˜ ê²½ìš°ì—ëŠ” ì¼ë°˜ ì „ìˆ  ì¡°ì–¸ ëª¨ë“œë¡œ ì‘ë™
        - í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•˜ì§€ ì•ŠìŒ (iifa, IIFA ëª¨ë‘ ì¸ì‹)
        """
        try:
            # ë ˆì´ì•„ì›ƒ ì •ë³´ ë¡œë“œ
            with open(self.layout_file, 'r', encoding='utf-8') as f:
                layout_str = f.read()
            
            # API ìš”ì²­ í—¤ë” ë° URL ì„¤ì •
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.api_key}"
            }
            api_url = "https://api.openai.com/v1/chat/completions"
            
            # ì–¸ì–´ ì„¤ì •
            lang_instruction = ""
            if self.language == "korean":
                lang_instruction = "ë‹¹ì‹ ì˜ ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ëª¨ë“  ìš©ì–´ì™€ ì„¤ëª…ì€ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì—¬ ì œê³µí•˜ì„¸ìš”."
            
            # ê°„ë‹¨í•œ IIFA í‚¤ì›Œë“œ ê¸°ë°˜ ì‹œê°í™” ìš”ì²­ í™•ì¸
            # ì§ˆë¬¸ì˜ ì‹œì‘ ë˜ëŠ” ëì— "IIFA"ê°€ ìˆëŠ”ì§€ í™•ì¸
            question_lower = self.question.lower().strip()
            is_code_request = question_lower.startswith("iifa") or question_lower.endswith("iifa")
            
            # IIFA í‚¤ì›Œë“œê°€ ìˆëŠ” ê²½ìš°, ì§ˆë¬¸ì—ì„œ í‚¤ì›Œë“œ ì œê±°
            if is_code_request:
                if question_lower.startswith("iifa"):
                    # "iifa" ë’¤ì— ê³µë°±ì´ ìˆì„ ê²½ìš° ì²˜ë¦¬
                    self.question = self.question.lstrip().lower().replace("iifa", "", 1).lstrip()
                elif question_lower.endswith("iifa"):
                    # "iifa" ì•ì— ê³µë°±ì´ ìˆì„ ê²½ìš° ì²˜ë¦¬
                    self.question = self.question.rstrip().lower().rstrip("iifa").rstrip()
            
            system_prompt = ""
            user_prompt = ""
            
            if is_code_request:
                # --- ì½”ë“œ ìƒì„± ìš”ì²­ í”„ë¡¬í”„íŠ¸ ---
                system_prompt = """ë‹¹ì‹ ì€ Python ì½”ë“œ ìƒì„± ë° ë°ì´í„° ì‹œê°í™” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ê³¼ ì œê³µëœ ì»¨í…ìŠ¤íŠ¸(ë ˆì´ì•„ì›ƒ, ë¸Œë¦¬í•‘ ë“±)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§€ë„, ì°¨íŠ¸, ê·¸ë¦¼ ë“±ì„ ìƒì„±í•˜ëŠ” Python ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

**ì¤‘ìš” ìš”êµ¬ì‚¬í•­:**
1. ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­í•œ ëª¨ë“  ìš”ì†Œì™€ ê¸°ëŠ¥ì„ ë¹ ì§ì—†ì´ êµ¬í˜„í•˜ì„¸ìš”.
2. ì‹œê°í™”ì—ëŠ” ì ì ˆí•œ ì œëª©, ë ˆì´ë¸”, ë²”ë¡€ ë“± í•„ìˆ˜ ìš”ì†Œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”.
3. ì‹œê°ì  ëª…í™•ì„±ì„ ìœ„í•´ ì ì ˆí•œ ìƒ‰ìƒ, í¬ê¸°, í°íŠ¸ í¬ê¸°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
4. ëª¨ë“  ë ˆì´ë¸”, íƒ€ì´í‹€, ì£¼ì„ì€ ë°˜ë“œì‹œ ì˜ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”. í•œêµ­ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

**ì¶œë ¥ í˜•ì‹:**
1. ì¶œë ¥ ì‹œì‘ ë¶€ë¶„ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì•ˆë‚´ë¥¼ í¬í•¨í•˜ì„¸ìš” (ì˜ˆ: `pip install matplotlib folium pandas`).
2. ìƒì„±ëœ Python ì½”ë“œë¥¼ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì•ˆì— ë„£ìœ¼ì„¸ìš” (```python ... ```).
3. ì½”ë“œëŠ” ë°˜ë“œì‹œ í˜„ì¬ ë””ë ‰í† ë¦¬ì— ê²°ê³¼ ì´ë¯¸ì§€ íŒŒì¼(PNG, JPG, HTML ë“±)ì„ ì €ì¥í•˜ë„ë¡ ì‘ì„±í•˜ê³ , íŒŒì¼ëª…ì„ ëª…í™•íˆ ì§€ì •í•˜ì„¸ìš”.
4. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸ì™€ í•„ìš”í•œ ëª¨ë“  ê¸°ëŠ¥ì´ í¬í•¨ëœ ì™„ì „í•œ ì‹¤í–‰ ê°€ëŠ¥ ì½”ë“œë¥¼ ì œê³µí•˜ì„¸ìš”.
5. íŒŒì¼ ì €ì¥ ê²½ë¡œëŠ” ìƒëŒ€ ê²½ë¡œë¡œ ì§€ì •í•˜ì—¬ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ì— ì €ì¥ë˜ê²Œ í•˜ì„¸ìš”.
6. ì½”ë“œë¥¼ ë„ˆë¬´ ë³µì¡í•˜ê²Œ ë§Œë“¤ì§€ ë§ê³ , ì‚¬ìš©ì ìš”ì²­ì„ ì •í™•íˆ ìˆ˜í–‰í•˜ëŠ” ê°„ê²°í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
7. ëª¨ë“  ì½”ë“œì— ì£¼ì„ì„ ë‹¬ì•„ ê° ë¶€ë¶„ì˜ ì—­í• ì„ ëª…í™•íˆ ì„¤ëª…í•˜ì„¸ìš”."""

                # í•„ìš”í•œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì— í¬í•¨
                user_prompt = f"""ë‹¤ìŒ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ìš”ì²­ì„ ì²˜ë¦¬í•˜ì„¸ìš”:

[ë ˆì´ì•„ì›ƒ ì •ë³´]
{layout_str}... (ìƒëµ)

[ë¸Œë¦¬í•‘ ë‚´ìš© ìš”ì•½]
{self.briefing_content}... (ìƒëµ)

[ì‚¬ìš©ì ìš”ì²­]
{self.question}

**í”„ë¡œê·¸ë˜ë° ìš”êµ¬ì‚¬í•­:**
1. í•„ìš”í•œ ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ import í•˜ëŠ” ì½”ë“œë¥¼ í¬í•¨í•˜ì„¸ìš”.
2. ì™„ì „í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ Python ì½”ë“œë¥¼ ì œê³µí•˜ì„¸ìš”.
3. ê²°ê³¼ íŒŒì¼(ì§€ë„, ì°¨íŠ¸, ê·¸ë¦¼ ë“±)ì€ ëª…í™•í•œ íŒŒì¼ëª…ìœ¼ë¡œ í˜„ì¬ ë””ë ‰í† ë¦¬ì— ì €ì¥í•˜ì„¸ìš”.
4. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```python ... ```) ì•ˆì— ì½”ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
5. ì‚¬ìš©ìê°€ ìš”ì²­í•œ ëª¨ë“  ìš”ì†Œ(ìƒ‰ìƒ, ìŠ¤íƒ€ì¼, ë°ì´í„° í•­ëª© ë“±)ë¥¼ ì •í™•íˆ êµ¬í˜„í•˜ì„¸ìš”.
6. ë°ì´í„°ê°€ ì‹œê°ì ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ë³´ì´ë„ë¡ ê·¸ë˜í”„ í¬ê¸°, í°íŠ¸ í¬ê¸°, ìƒ‰ìƒ ë“±ì„ ì ì ˆíˆ ì¡°ì •í•˜ì„¸ìš”.
7. ëª¨ë“  ë ˆì´ë¸”, ì œëª©, ì£¼ì„ì€ ì˜ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”. í•œêµ­ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
8. ë°ì´í„° ì‹œê°í™”ì— í•„ìš”í•œ ì ì ˆí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:
   - ì¼ë°˜ ê·¸ë˜í”„/ì°¨íŠ¸: matplotlib, seaborn
   - ì¸í„°ë™í‹°ë¸Œ ì°¨íŠ¸: plotly
   - ì§€ë„: folium, geopandas
   - 3D ì‹œê°í™”: matplotlib(3D), plotly
   - ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„: networkx
9. ì˜¤ë¥˜ ì²˜ë¦¬ ì½”ë“œë¥¼ í¬í•¨í•˜ì—¬ ì˜ˆì™¸ ìƒí™©ì— ëŒ€ì‘í•˜ì„¸ìš”.
10. ì½”ë“œ ì‹¤í–‰ ì „ í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ëª…ë ¹ì–´ë¥¼ ì½”ë“œ ì™¸ë¶€ì— ëª…ì‹œí•˜ì„¸ìš”.
11. ì‚¬ìš©ìê°€ 2D ë ˆì´ì•„ì›ƒì„ ìš”ì²­í•œ ê²½ìš° ë²½, ì°½ë¬¸, ë¬¸ì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ì°½ë¬¸ê³¼ ë¬¸ì€ ë²½ì˜ ëª¨ì–‘ê³¼ ë°©í–¥ì— ë§ì¶° ì •ë ¬í•˜ì„¸ìš”."""
            else:
                # --- ê¸°ì¡´ Q&A í”„ë¡¬í”„íŠ¸ ---
                system_prompt = f"""ë‹¹ì‹ ì€ ê³ ê¸‰ êµ°ì‚¬ ì‘ì „ ì°¸ëª¨ ë° ì§€íœ˜ ê²°ì‹¬ ë³´ì¢Œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ 3D ê³µê°„ ë ˆì´ì•„ì›ƒ ì •ë³´ì™€ ì´ë¯¸ ìƒì„±ëœ ì „ìˆ ì  ë¸Œë¦¬í•‘ì„ ë°”íƒ•ìœ¼ë¡œ ì§€íœ˜ê´€ì—ê²Œ ì‘ì „ ì§€íœ˜ê²°ì‹¬ì„ ìœ„í•œ ì •í™•í•œ ì¡°ì–¸ê³¼ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.

ì§€íœ˜ê´€ê³¼ì˜ ìƒí˜¸ì‘ìš©ì—ì„œ ë‹¤ìŒ ì—­í• ì„ ìˆ˜í–‰í•˜ì„¸ìš”:
1. ì˜ì‚¬ê²°ì • ì´‰ì§„ì: ì§€íœ˜ê´€ì´ ì‹ ì†í•˜ê³  íš¨ê³¼ì ì¸ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ í•„ìš”í•œ ì •ë³´ë¥¼ ëª…í™•í•˜ê²Œ ì œê³µ
2. ë¶„ì„ê°€: ë°ì´í„° ê¸°ë°˜ ì •ë³´ë¥¼ í•´ì„í•˜ì—¬ ì§€íœ˜ê´€ì´ ìƒí™©ì„ ì™„ì „íˆ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì§€ì›
3. ìœ„í—˜ í‰ê°€ì: ë‹¤ì–‘í•œ í–‰ë™ ë°©ì¹¨ì˜ ìœ„í—˜ê³¼ ê¸°íšŒë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ í‰ê°€í•˜ì—¬ ì œì‹œ
4. ì˜µì…˜ ì œì‹œì: ì—¬ëŸ¬ê°œì˜ ì‹¤í–‰ ê°€ëŠ¥í•œ ëŒ€ì•ˆì„ ìš°ì„ ìˆœìœ„ì™€ í•¨ê»˜ ì œì‹œ

ë‹µë³€ í˜•ì‹:
- ì •ë³´ ì „ë‹¬ ì‹œ ë§ˆí¬ë‹¤ìš´ì€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì ì ˆíˆ í™œìš©í•˜ì„¸ìš”.
- í•µì‹¬ ì •ë³´ì™€ ì£¼ìš” êµ¬ë¶„ì´ í•„ìš”í•œ ê²½ìš° ì œëª©(##, ###)ì„ ì‚¬ìš©í•˜ì„¸ìš”.
- ì£¼ìš” ì˜µì…˜ì´ë‚˜ ì¤‘ìš” í•­ëª©ì€ ëª©ë¡ìœ¼ë¡œ êµ¬ë¶„í•˜ì„¸ìš”.
- ì¤‘ìš”í•œ ê²½ê³ ë‚˜ ìœ„í—˜ì€ ê°•ì¡°í•˜ì„¸ìš”.
- í†µê³„ ë°ì´í„°ë‚˜ ë¹„êµê°€ í•„ìš”í•œ ê²½ìš° í‘œë¥¼ í™œìš©í•˜ì„¸ìš”.
- ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ë‹¨ íë¦„ì„ ìœ ì§€í•˜ê³ , ëª¨ë“  ë‚´ìš©ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ê°•ì œí•˜ì§€ ë§ˆì„¸ìš”.
- ì•„ë˜ì˜ ì›ì¹™ì„ ì¤€ìˆ˜í•˜ë˜, ì§€ë‚˜ì¹˜ê²Œ ì–‘ì‹ì— êµ¬ì• ë°›ì§€ ë§ˆì„¸ìš”. ì§ˆë¬¸ê³¼ ë‹µë³€ í˜•íƒœì— ë§ì¶° ì ì ˆí•œ í˜•íƒœë¡œ ë‹µë³€í•˜ì„¸ìš”.

ë‹¤ìŒ ì›ì¹™ì„ ì¤€ìˆ˜í•˜ì„¸ìš”:
- êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ ë°ì´í„°ì— ê¸°ë°˜í•œ ê°ê´€ì ì´ê³  ëª…í™•í•œ ë‹µë³€ ì œê³µ
- ê°€ëŠ¥í•œ í•œ ì •í™•í•œ ìˆ˜ì¹˜, ì¢Œí‘œ, ì‹œê°„, ê±°ë¦¬ ë“± êµ¬ì²´ì  ë°ì´í„° í¬í•¨
- ì§€íœ˜ê´€ì˜ ì§ˆë¬¸ì— ëŒ€í•´ ê°„ê²°í•˜ë©´ì„œë„ ì¶©ë¶„íˆ ìƒì„¸í•œ ì •ë³´ ì œê³µ
- ëŒ€ì•ˆì˜ ì¥ë‹¨ì ê³¼ ìœ„í—˜ ìš”ì†Œë¥¼ êµ¬ì²´ì ì¸ ê·¼ê±°ì™€ í•¨ê»˜ í‰ê°€
- ì‹¤í–‰ ê°€ëŠ¥í•œ ì˜µì…˜ì„ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ í˜„ì‹¤ì  ì œì•½ì„ ê³ ë ¤í•˜ì—¬ ì œì‹œ
- ë ˆì´ì•„ì›ƒ ë° ë¸Œë¦¬í•‘ ì •ë³´ë¡œë¶€í„° ì¶”ë¡ í•œ ê·¼ê±°ë¥¼ ëª…í™•íˆ ì œì‹œ
- ê¸´ê¸‰ ìƒí™©ì—ì„œ ì‹ ì†í•œ ê²°ì •ì„ ìœ„í•œ í•µì‹¬ ì‚¬í•­ ê°•ì¡°
- ë¶ˆí™•ì‹¤í•œ ì •ë³´ëŠ” ê·¸ ë¶ˆí™•ì‹¤ì„±ì˜ ì •ë„ì™€ í•¨ê»˜ í‘œì‹œ

**ì¤‘ìš”:** ì§ˆë¬¸ì˜ ë‚´ìš©ê³¼ ì˜ë„ë¥¼ ì •í™•íˆ íŒŒì•…í•˜ì—¬ ì ì ˆí•œ í˜•íƒœë¡œ ëŒ€ì‘í•˜ì„¸ìš”. ì‹œê°í™”ë‚˜ ë°ì´í„° í‘œí˜„ì„ ëª…ì‹œì ìœ¼ë¡œ ìš”ì²­í•˜ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”í˜• ë‹µë³€ì„ ì œê³µí•˜ê³ , ì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”."""

                # ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ìƒì„±
                user_prompt = f"""ë‹¤ìŒì€ 3D ê³µê°„ì˜ ìƒì„¸ ë ˆì´ì•„ì›ƒ ì •ë³´ì…ë‹ˆë‹¤:

{layout_str}

ê·¸ë¦¬ê³  ì´ ê³µê°„ì— ëŒ€í•´ ìƒì„±ëœ ì „ìˆ ì  ë¸Œë¦¬í•‘ ë‚´ìš©ì…ë‹ˆë‹¤:

{self.briefing_content}

ìœ„ ì •ë³´ë¥¼ í† ëŒ€ë¡œ ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•´ ë‹µë³€í•´ì£¼ì„¸ìš”:

{self.question}

ë‹¤ìŒ ì§€ì¹¨ì— ë”°ë¼ ì‘ë‹µí•´ì£¼ì„¸ìš”:
1. ì •ë³´ êµ¬ì¡°í™”ê°€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì ì ˆíˆ ë§ˆí¬ë‹¤ìš´ì„ í™œìš©í•˜ì„¸ìš”. ëª¨ë“  ë‚´ìš©ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ê°•ì œí•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ¬ìš´ íë¦„ì„ ìœ ì§€í•˜ì„¸ìš”.

2. êµ¬ì²´ì ì¸ ê·¼ê±°ì™€ ìƒì„¸ ì •ë³´ë¥¼ ì œê³µí•˜ì„¸ìš”:
   - ê°€ëŠ¥í•œ í•œ ì •í™•í•œ ìˆ˜ì¹˜(ê±°ë¦¬, ì‹œê°„, ê°ë„, ì¢Œí‘œ ë“±)ë¥¼ í¬í•¨í•˜ì„¸ìš”
   - ê³µê°„ì˜ êµ¬ì²´ì ì¸ íŠ¹ì„±ê³¼ ê·¸ ì „ìˆ ì  ì˜ë¯¸ë¥¼ ì„¤ëª…í•˜ì„¸ìš”
   - ì¶”ë¡ ì˜ ê³¼ì •ê³¼ ê·¼ê±°ë¥¼ ëª…í™•íˆ í•˜ì„¸ìš”
   - ì œì•ˆí•˜ëŠ” ì˜µì…˜ì˜ ì‹¤í–‰ ê°€ëŠ¥ì„±ì— ëŒ€í•œ êµ¬ì²´ì  í‰ê°€ë¥¼ í¬í•¨í•˜ì„¸ìš”

3. ì˜µì…˜ì„ ì œì‹œí•  ë•ŒëŠ”:
   - ê° ì˜µì…˜ì˜ êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ë²•(ëˆ„ê°€, ì–´ë””ì„œ, ì–´ë–»ê²Œ)ì„ í¬í•¨í•˜ì„¸ìš”
   - ì˜ˆìƒë˜ëŠ” ê²°ê³¼ì™€ ì ì¬ì  ì¥ì• ìš”ì†Œë¥¼ ì„¤ëª…í•˜ì„¸ìš”
   - í•„ìš”í•œ ìì›ê³¼ ì‹œê°„ì„ ëª…ì‹œí•˜ì„¸ìš”
   - ì„±ê³µ í™•ë¥ ì— ëŒ€í•œ í‰ê°€ë¥¼ ì œê³µí•˜ì„¸ìš”

4. ì‘ë‹µì„ í†µí•´ ì§€íœ˜ê´€ì´ ì¦‰ì‹œ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆì„ ì •ë„ë¡œ ëª…í™•í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ ì œê³µí•˜ì„¸ìš”.

5. ì§ˆë¬¸ì˜ ì„±ê²©ì— ë”°ë¼ ì ì ˆí•œ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”:
   - ì¼ë°˜ì ì¸ ì¡°ì–¸ì´ë‚˜ ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” ê²½ìš°: ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”í˜• ë‹µë³€
   - ì „ìˆ ì  ê²°ì •ì´ í•„ìš”í•œ ê²½ìš°: êµ¬ì¡°í™”ëœ ì˜µì…˜ ì œì‹œ
   - ë¶„ì„ì„ ìš”ì²­í•˜ëŠ” ê²½ìš°: ë°ì´í„° ê¸°ë°˜ ë¶„ì„ ê²°ê³¼
   - íŠ¹ë³„íˆ ì‹œê°í™”ë¥¼ ìš”ì²­í•˜ì§€ ì•ŠëŠ” í•œ ì½”ë“œë¥¼ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”.

ë ˆì´ì•„ì›ƒì˜ ê³µê°„ì  íŠ¹ì„±ê³¼ ì „ìˆ ì  ë¸Œë¦¬í•‘ì—ì„œ ì œê³µëœ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì§€íœ˜ê´€ì˜ ê²°ì‹¬ì— ì§ì ‘ì ìœ¼ë¡œ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ì„ ì œì‹œí•˜ì‹­ì‹œì˜¤.{lang_instruction}"""
            
            # ë©”ì‹œì§€ êµ¬ì„±
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
            
            # API ìš”ì²­ ë³¸ë¬¸ êµ¬ì„± - ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í™œì„±í™”
            request_body = {
                "model": self.model,
                "messages": messages,
                "temperature": 0.25,
                "max_tokens": 10000,
                "top_p": 0.95,
                "frequency_penalty": 0,
                "presence_penalty": 0.1,  # ì•½ê°„ì˜ ë‹¤ì–‘ì„± ì¶”ê°€
                "stream": True  # ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í™œì„±í™”
            }
            
            # ì „ì²´ ì‘ë‹µì„ ì €ì¥í•  ë³€ìˆ˜
            full_response = ""
            
            # API ìš”ì²­ ì „ì†¡ (ìŠ¤íŠ¸ë¦¬ë°)
            with requests.post(
                api_url,
                headers=headers,
                json=request_body,
                timeout=120,  # íƒ€ì„ì•„ì›ƒ 120ì´ˆ
                stream=True  # ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ
            ) as response:
                
                if response.status_code == 200:
                    for line in response.iter_lines():
                        if line:
                            line_text = line.decode('utf-8')
                            
                            # "data: " ì ‘ë‘ì‚¬ ì²˜ë¦¬
                            if line_text.startswith("data: "):
                                line_text = line_text[6:]  # "data: " ì œê±°
                            
                            # ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ë©”ì‹œì§€ í™•ì¸
                            if line_text == "[DONE]":
                                break
                                
                            try:
                                # JSON íŒŒì‹±
                                json_data = json.loads(line_text)
                                
                                # ë¸íƒ€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                                if "choices" in json_data and json_data["choices"]:
                                    delta = json_data["choices"][0].get("delta", {})
                                    
                                    if "content" in delta:
                                        content = delta["content"]
                                        full_response += content
                                        # ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì‹œê·¸ë„ ë°œìƒ
                                        self.stream_signal.emit(content)
                            except json.JSONDecodeError:
                                # JSON ë””ì½”ë”© ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
                                continue
                    
                    # ì½”ë“œ ìƒì„± ìš”ì²­ì¸ ê²½ìš°, ì½”ë“œ ë¶€ë¶„ ì¶”ì¶œ
                    if is_code_request:
                        # ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì—ì„œ Python ì½”ë“œ ë¸”ë¡ ì¶”ì¶œ
                        import re
                        code_pattern = r'```python\s*(.*?)\s*```'
                        code_matches = re.findall(code_pattern, full_response, re.DOTALL)
                        
                        if code_matches:
                            # ì½”ë“œ ì¶”ì¶œì— ì„±ê³µí•˜ë©´ ì‹œê·¸ë„ ë°œìƒ
                            extracted_code = code_matches[0]
                            self.code_generated_signal.emit(extracted_code)
                    
                    # ìŠ¤íŠ¸ë¦¬ë°ì´ ì™„ë£Œë˜ë©´ ìµœì¢… ì‘ë‹µ ì „ì†¡
                    self.answer_signal.emit(full_response)
                else:
                    error_msg = f"API ì˜¤ë¥˜ (ì½”ë“œ {response.status_code}): {response.text}"
                    self.error_signal.emit(error_msg)
        
        except Exception as e:
            self.error_signal.emit(f"ì§ˆë¬¸ ì²˜ë¦¬ ì˜¤ë¥˜: {str(e)}")

class ApiKeyDialog(QDialog):
    """
    API í‚¤ ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸
    """
    def __init__(self, parent=None, current_key=""):
        super().__init__(parent)
        self.setWindowTitle("ChatGPT API í‚¤ ì„¤ì •")
        self.resize(500, 180)
        
        layout = QVBoxLayout()
        
        # ì„¤ëª… ë ˆì´ë¸”
        info_label = QLabel("OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. API í‚¤ëŠ” ë¡œì»¬ì— ì•”í˜¸í™”ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì €ì¥ë©ë‹ˆë‹¤. "
                           "í•œ ë²ˆ ì…ë ¥í•˜ë©´ ë‹¤ìŒì— í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ë•Œ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.")
        info_label.setWordWrap(True)
        layout.addWidget(info_label)
        
        # API í‚¤ ì…ë ¥ í¼
        form_layout = QFormLayout()
        self.api_key_input = QLineEdit()
        self.api_key_input.setText(current_key)
        self.api_key_input.setEchoMode(QLineEdit.Password)
        self.api_key_input.setMinimumWidth(350)
        form_layout.addRow("API í‚¤:", self.api_key_input)
        
        # ëª¨ë¸ ì„ íƒ
        self.model_combo = QComboBox()
        self.model_combo.addItems(["gpt-4o-2024-11-20", "gpt-4o-mini-2024-07-18", "o1-2024-12-17"])
        # ê¸°ë³¸ ëª¨ë¸ ì„ íƒ (gpt-4o)
        self.model_combo.setCurrentIndex(0)
        form_layout.addRow("ëª¨ë¸:", self.model_combo)
        
        layout.addLayout(form_layout)
        
        # ë²„íŠ¼ ì˜ì—­
        button_layout = QHBoxLayout()
        self.save_button = QPushButton("ì €ì¥")
        self.cancel_button = QPushButton("ì·¨ì†Œ")
        
        self.save_button.clicked.connect(self.accept)
        self.save_button.setStyleSheet("""
            QPushButton {
                background-color: #2ecc71;
                color: white;
                border-radius: 4px;
                padding: 6px 12px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #27ae60;
            }
        """)
        
        self.cancel_button.clicked.connect(self.reject)
        
        button_layout.addWidget(self.save_button)
        button_layout.addWidget(self.cancel_button)
        
        layout.addLayout(button_layout)
        self.setLayout(layout)
    
    def get_api_key(self):
        """API í‚¤ ë°˜í™˜"""
        return self.api_key_input.text()
    
    def get_model(self):
        """ì„ íƒëœ ëª¨ë¸ ë°˜í™˜"""
        return self.model_combo.currentText()

class BriefingViewer(QMainWindow):
    """
    ë¸Œë¦¬í•‘ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” ë©”ì¸ ìœˆë„ìš°
    """
    def __init__(self, rrd_file, model_path="manycore-research/SpatialLM-Llama-1B", language="korean", layout_file=None, briefing_file=None):
        super().__init__()
        
        # RRD íŒŒì¼ ê²½ë¡œ ì„¤ì •
        self.rrd_file = rrd_file
        self.rrd_dir = os.path.dirname(self.rrd_file)
        self.basename = os.path.splitext(os.path.basename(self.rrd_file))[0]
        
        # SpatialLM ëª¨ë¸ ê²½ë¡œ ì„¤ì •
        self.model_path = model_path
        
        # ì–¸ì–´ ì„¤ì •
        self.language = language
        
        # OpenAI API ì„¤ì •
        self.config_dir = os.path.expanduser("~/.spatialLM")
        self.config_file = os.path.join(self.config_dir, "api_config.ini")
        self.openai_api_key = ""
        self.openai_model = "gpt-4"
        
        # API ì„¤ì • ë¡œë“œ
        self.load_api_config()
        
        # ì„ì‹œ íŒŒì¼ ì„¤ì •
        self.tmp_briefing_file = os.path.join(self.rrd_dir, f"{self.basename}_briefing_tmp.md")
        
        # ë ˆì´ì•„ì›ƒ íŒŒì¼ ê²½ë¡œ ê²°ì •
        if layout_file and os.path.exists(layout_file):
            # ëª…ì‹œì ìœ¼ë¡œ ì œê³µëœ ë ˆì´ì•„ì›ƒ íŒŒì¼ ì‚¬ìš©
            self.layout_file = layout_file
        else:
            # ìë™ìœ¼ë¡œ ë ˆì´ì•„ì›ƒ íŒŒì¼ ì°¾ê¸°
            # 1. ê°™ì€ ì´ë¦„ì˜ í…ìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
            possible_layout_files = [
                os.path.join(self.rrd_dir, f"{self.basename}.txt"),  # ê°™ì€ ë””ë ‰í† ë¦¬, ê°™ì€ ì´ë¦„
                os.path.join(os.getcwd(), f"{self.basename}.txt"),   # í˜„ì¬ ë””ë ‰í† ë¦¬, ê°™ì€ ì´ë¦„
                os.path.join("layouts", f"{self.basename}.txt"),     # layouts ë””ë ‰í† ë¦¬
                os.path.join(os.path.dirname(self.rrd_dir), "layouts", f"{self.basename}.txt")  # ìƒìœ„ ë””ë ‰í† ë¦¬/layouts
            ]
            
            # 2. ìœ ì‚¬í•œ ì´ë¦„ì˜ í…ìŠ¤íŠ¸ íŒŒì¼ í™•ì¸ (í™•ì¥ìë§Œ ë‹¤ë¥¸ ê²½ìš°)
            for ext in ['.layout', '.lay', '.map']:
                possible_layout_files.append(os.path.join(self.rrd_dir, f"{self.basename}{ext}"))
                possible_layout_files.append(os.path.join(os.getcwd(), f"{self.basename}{ext}"))
                possible_layout_files.append(os.path.join("layouts", f"{self.basename}{ext}"))
            
            # 3. ë¹„ìŠ·í•œ ì´ë¦„ì˜ íŒŒì¼ ì°¾ê¸° (optional_XXXX ê°™ì€ ì ‘ë¯¸ì‚¬ ì œê±° ì‹œë„)
            base_name_parts = self.basename.split('_')
            if len(base_name_parts) > 1:
                simpler_name = '_'.join(base_name_parts[:-1])
                for ext in ['.txt', '.layout', '.lay', '.map']:
                    possible_layout_files.append(os.path.join(self.rrd_dir, f"{simpler_name}{ext}"))
                    possible_layout_files.append(os.path.join(os.getcwd(), f"{simpler_name}{ext}"))
                    possible_layout_files.append(os.path.join("layouts", f"{simpler_name}{ext}"))
            
            # ê°€ëŠ¥í•œ ëª¨ë“  íŒŒì¼ ì¤‘ì—ì„œ ì¡´ì¬í•˜ëŠ” ì²« ë²ˆì§¸ íŒŒì¼ ì„ íƒ
            self.layout_file = None
            for file_path in possible_layout_files:
                if os.path.exists(file_path):
                    self.layout_file = file_path
                    break
            
            # ë ˆì´ì•„ì›ƒ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ì—ëŸ¬ í‘œì‹œ
            if not self.layout_file:
                error_msg = f"ë ˆì´ì•„ì›ƒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. '{self.basename}.txt' íŒŒì¼ì´ í˜„ì¬ ë””ë ‰í† ë¦¬ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
                QMessageBox.critical(self, "ì˜¤ë¥˜", error_msg)
                sys.exit(1)
        
        # ë¸Œë¦¬í•‘ íŒŒì¼ ì„¤ì •
        self.briefing_file = briefing_file
        
        # ë§ˆí¬ë‹¤ìš´ ë·° ì„¤ì •
        self.markdown_view = True
        self.qa_markdown_view = True  # ì§ˆë¬¸-ë‹µë³€ ì˜ì—­ ë§ˆí¬ë‹¤ìš´ ë·° ì„¤ì •
        
        # ìŠ¤íŠ¸ë¦¬ë° ì„¤ì •
        self.is_briefing_streaming = False
        self.streaming_briefing_text = ""
        
        # Q&A íˆìŠ¤í† ë¦¬ ì„¤ì •
        self.qa_history_list = []
        
        # ìœˆë„ìš° ì„¤ì •
        self.setWindowTitle(f"SpatialLM ë¸Œë¦¬í•‘ ë·°ì–´ - {self.basename}")
        self.resize(1200, 800)  # ì´ˆê¸° ì°½ í¬ê¸°
        self.setWindowIcon(self.create_default_icon())
        
        # í•œê¸€ í°íŠ¸ ì„¤ì •
        self.initialize_korean_fonts()
        
        # UI ì´ˆê¸°í™”
        self.init_ui()
        
        # ê¸°ì¡´ ë¸Œë¦¬í•‘ íŒŒì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ
        if self.briefing_file and os.path.exists(self.briefing_file):
            try:
                with open(self.briefing_file, 'r', encoding='utf-8') as f:
                    briefing_content = f.read()
                self.update_briefing_content(briefing_content)
                self.briefing_completed(briefing_content)
                print(f"Loaded existing briefing from {self.briefing_file}")
            except Exception as e:
                print(f"Error loading existing briefing: {e}")
                # ë¸Œë¦¬í•‘ ìƒì„± ìŠ¤ë ˆë“œ ì‹œì‘
                self.start_briefing_generation()
        else:
            # ë¸Œë¦¬í•‘ ìƒì„± ìŠ¤ë ˆë“œ ì‹œì‘
            self.start_briefing_generation()
        
        # Rerun ë·°ì–´ ì‹œì‘ 
        self.start_rerun_viewer()

    def initialize_korean_fonts(self):
        """í•œê¸€ í°íŠ¸ ì„¤ì •"""
        # ì‹œìŠ¤í…œì— ì„¤ì¹˜ëœ í°íŠ¸ í™•ì¸
        font_db = QFontDatabase()
        available_fonts = font_db.families()
        print("Available fonts:", available_fonts)
        
        # ë¡œì»¬ í°íŠ¸ ì„¤ì¹˜
        self.install_local_fonts()
        
        # í•œê¸€ ì§€ì› í°íŠ¸ ëª©ë¡
        korean_fonts = [
            "NanumGothic", "Nanum Gothic", "Malgun Gothic", "ë§‘ì€ ê³ ë”•",
            "Gulim", "êµ´ë¦¼", "Batang", "ë°”íƒ•", "Dotum", "ë‹ì›€",
            "AppleGothic", "Apple Gothic", "Noto Sans CJK KR",
            "ë‚˜ëˆ”ê³ ë”•", "ë‚˜ëˆ”ë°”ë¥¸ê³ ë”•", "ë‚˜ëˆ”ìŠ¤í€˜ì–´", "ë³¸ê³ ë”•",
            "Source Han Sans K", "ë³¸ê³ ë”• KR"
        ]
        
        # í•œê¸€ í°íŠ¸ ê²€ìƒ‰
        self.korean_font = None
        for font_name in korean_fonts:
            if font_name in available_fonts:
                print(f"Found Korean font: {font_name}")
                self.korean_font = font_name
                break
        
        # í°íŠ¸ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©
        if not self.korean_font:
            print("No Korean font found, using default font")
            self.korean_font = QFont().family()
            
        # ê¸°ë³¸ í°íŠ¸ ì„¤ì •
        default_font = QFont(self.korean_font, 10)
        QApplication.setFont(default_font)
        
        print(f"Using font: {self.korean_font}")

    def install_local_fonts(self):
        """ë¡œì»¬ í°íŠ¸ ì„¤ì¹˜"""
        try:
            # ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ì°¾ê¸°
            script_dir = os.path.dirname(os.path.abspath(__file__))
            
            # fonts ë””ë ‰í† ë¦¬ì—ì„œ í°íŠ¸ ì°¾ê¸°
            fonts_dir = os.path.join(script_dir, "fonts")
            
            if os.path.exists(fonts_dir):
                for font_file in os.listdir(fonts_dir):
                    if font_file.lower().endswith(('.ttf', '.otf')):
                        font_path = os.path.join(fonts_dir, font_file)
                        font_id = QFontDatabase.addApplicationFont(font_path)
                        if font_id != -1:
                            print(f"Successfully loaded font: {font_file}")
                        else:
                            print(f"Failed to load font: {font_file}")
        except Exception as e:
            print(f"Error installing local fonts: {e}")

    def init_ui(self):
        """UI ì´ˆê¸°í™”"""
        # ìœˆë„ìš° ì„¤ì •
        self.setWindowTitle(f"SpatialLM ë¸Œë¦¬í•‘ ë·°ì–´ - {self.basename}")
        self.resize(1200, 800)  # ì´ˆê¸° ì°½ í¬ê¸°
        self.setWindowIcon(self.create_default_icon())
        
        # ìŠ¤íƒ€ì¼ ì„¤ì •
        self.apply_modern_style()
        
        # ë©”ì¸ ìœ„ì ¯
        main_widget = QWidget()
        
        # ë©”ì¸ ë ˆì´ì•„ì›ƒ
        main_layout = QVBoxLayout(main_widget)
        main_layout.setContentsMargins(10, 8, 10, 10)
        main_layout.setSpacing(8)
        
        # ===== í—¤ë” ì„¹ì…˜ (ì»´íŒ©íŠ¸í•˜ê²Œ ìˆ˜ì •) =====
        header_container = QWidget()
        header_container.setObjectName("headerContainer")
        header_container.setStyleSheet("""
            #headerContainer {
                background-color: #ffffff;
                border-radius: 6px;
            }
        """)
        
        header_shadow = QGraphicsDropShadowEffect()
        header_shadow.setBlurRadius(8)
        header_shadow.setColor(QColor(0, 0, 0, 40))
        header_shadow.setOffset(0, 2)
        header_container.setGraphicsEffect(header_shadow)
        
        # ë†’ì´ ì œí•œ ì„¤ì •
        header_container.setMaximumHeight(90)
        
        header_layout = QVBoxLayout(header_container)
        header_layout.setContentsMargins(12, 8, 12, 8)
        header_layout.setSpacing(5)
        
        # íƒ€ì´í‹€ ë ˆì´ì•„ì›ƒ
        title_layout = QHBoxLayout()
        title_layout.setContentsMargins(0, 0, 0, 0)
        title_layout.setSpacing(5)
        
        # ë¡œê³ /ì•„ì´ì½˜ ì˜ì—­ (ìˆìœ¼ë©´ ì¶”ê°€)
        try:
            logo_path = os.path.join(script_dir, "assets", "logo.png")
            if os.path.exists(logo_path):
                logo_label = QLabel()
                logo_pixmap = QPixmap(logo_path)
                logo_label.setPixmap(logo_pixmap.scaled(24, 24, Qt.KeepAspectRatio, Qt.SmoothTransformation))
                title_layout.addWidget(logo_label)
        except:
            pass
        
        # ì œëª© ë ˆì´ë¸” (í¬ê¸° ì¶•ì†Œ)
        header_title = QLabel(f"IIFA AI ì§€íœ˜ê²°ì‹¬ì§€ì›ì²´ê³„ (ì°¨ì„¸ëŒ€C5ì‹œìŠ¤í…œê³¼ í”„ë¡œí† íƒ€ì…)")
        header_title.setFont(QFont(self.korean_font, 14, QFont.Bold))
        header_title.setStyleSheet("color: #2c3e50;")
        title_layout.addWidget(header_title)
        
        # íŒŒì¼ëª… í‘œì‹œ (ì‘ê²Œ)
        filename_label = QLabel(f"{self.basename}")
        filename_label.setFont(QFont(self.korean_font, 11))
        filename_label.setStyleSheet("color: #7f8c8d;")
        title_layout.addWidget(filename_label)
        
        title_layout.addStretch(1)
        
        # ì–¸ì–´ ì„ íƒ ì½¤ë³´ë°•ìŠ¤
        language_layout = QHBoxLayout()
        language_label = QLabel("ì–¸ì–´:")
        language_label.setFont(QFont(self.korean_font, 9))
        language_label.setStyleSheet("color: #7f8c8d;")
        
        self.language_combo = QComboBox()
        self.language_combo.addItems(["í•œêµ­ì–´", "English"])
        self.language_combo.setCurrentIndex(0 if self.language == "korean" else 1)
        self.language_combo.currentIndexChanged.connect(self.change_language)
        self.language_combo.setFixedWidth(80)
        self.language_combo.setFont(QFont(self.korean_font, 9))
        self.language_combo.setStyleSheet("""
            QComboBox {
                border: 1px solid #e0e0e0;
                border-radius: 3px;
                padding: 2px 5px;
                background-color: #f8f9fa;
                color: #2c3e50;
            }
            QComboBox::drop-down {
                border: 0px;
                width: 15px;
            }
            QComboBox::down-arrow {
                width: 10px;
                height: 10px;
            }
            QComboBox QAbstractItemView {
                border: 1px solid #e0e0e0;
                selection-background-color: #3498db;
            }
        """)
        
        language_layout.addWidget(language_label)
        language_layout.addWidget(self.language_combo)
        
        title_layout.addLayout(language_layout)
        header_layout.addLayout(title_layout)
        
        # ìƒíƒœ í‘œì‹œ ë° ì§„í–‰ë¥ 
        status_layout = QHBoxLayout()
        status_layout.setContentsMargins(0, 0, 0, 0)
        status_layout.setSpacing(5)
        
        status_icon_label = QLabel()
        status_icon_label.setFixedSize(12, 12)
        status_layout.addWidget(status_icon_label)
        
        self.status_label = QLabel("ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...")
        self.status_label.setFont(QFont(self.korean_font, 10))
        self.status_label.setStyleSheet("color: #7f8c8d; margin-left: 2px;")
        status_layout.addWidget(self.status_label)
        
        status_layout.addStretch(1)
        
        self.progress_bar = QProgressBar()
        self.progress_bar.setRange(0, 100)
        self.progress_bar.setValue(0)
        self.progress_bar.setTextVisible(True)
        self.progress_bar.setFixedWidth(300)  # 200ì—ì„œ 300ìœ¼ë¡œ ë„ˆë¹„ ì¦ê°€
        self.progress_bar.setFixedHeight(20)  # 12ì—ì„œ 20ìœ¼ë¡œ ë†’ì´ ì¦ê°€
        self.progress_bar.setStyleSheet("""
            QProgressBar {
                border: none;
                border-radius: 5px;
                background-color: #f0f0f0;
                height: 20px;
                text-align: center;
                font-size: 12px;
                font-weight: bold;
                color: #2c3e50;
            }
            QProgressBar::chunk {
                background-color: #3498db;
                border-radius: 5px;
            }
        """)
        
        status_layout.addWidget(self.progress_bar)
        header_layout.addLayout(status_layout)
        
        main_layout.addWidget(header_container)
        
        # ===== ìŠ¤í”Œë¦¬í„° ìƒì„± (ì¢Œìš° ë¶„í• ) - ë” í° ê³µê°„ ë°°ì • =====
        splitter = QSplitter(Qt.Horizontal)
        splitter.setHandleWidth(6)
        splitter.setStyleSheet("""
            QSplitter::handle {
                background-color: #e0e0e0;
                border: 1px solid #cccccc;
                border-radius: 2px;
            }
            QSplitter::handle:hover {
                background-color: #3498db;
            }
        """)
        
        # ìŠ¤í”Œë¦¬í„°ì— ë” ë§ì€ ë¹„ì¤‘ ì„¤ì • (ë©”ì¸ ì˜ì—­ì´ ë” í¬ê²Œ í‘œì‹œë˜ë„ë¡)
        main_layout.addWidget(splitter, 1)  # ëŠ˜ì–´ë‚˜ëŠ” ê³µê°„ ëª¨ë‘ í• ë‹¹
        
        # ===== ì™¼ìª½ ì»¨í…Œì´ë„ˆ (ë¸Œë¦¬í•‘ ì •ë³´) =====
        left_container = QWidget()
        left_layout = QVBoxLayout(left_container)
        left_layout.setContentsMargins(0, 0, 5, 0)
        left_layout.setSpacing(10)
        
        # ë¸Œë¦¬í•‘ ì •ë³´ ì„¹ì…˜ (ì¢Œì¸¡)
        briefing_container = QWidget()
        briefing_container.setObjectName("briefingContainer")
        briefing_container.setStyleSheet("""
            #briefingContainer {
                background-color: #ffffff;
                border-radius: 8px;
            }
        """)
        
        briefing_shadow = QGraphicsDropShadowEffect()
        briefing_shadow.setBlurRadius(10)
        briefing_shadow.setColor(QColor(0, 0, 0, 40))
        briefing_shadow.setOffset(0, 2)
        briefing_container.setGraphicsEffect(briefing_shadow)
        
        briefing_layout = QVBoxLayout(briefing_container)
        briefing_layout.setContentsMargins(15, 12, 15, 12)
        briefing_layout.setSpacing(8)
        
        # ë¸Œë¦¬í•‘ ì œëª©
        briefing_title = QLabel("ë¸Œë¦¬í•‘ ì •ë³´")
        briefing_title.setFont(QFont(self.korean_font, 12, QFont.Bold))
        briefing_title.setStyleSheet("color: #2c3e50; margin-bottom: 2px;")
        briefing_layout.addWidget(briefing_title)
        
        # ë¸Œë¦¬í•‘ ì½˜í…ì¸  ì˜ì—­ (ì—¬ë°± ì¶•ì†Œ)
        self.briefing_text = QTextEdit()
        self.briefing_text.setFont(QFont(self.korean_font, 11))
        self.briefing_text.setReadOnly(True)
        self.briefing_text.setAcceptRichText(True)
        self.briefing_text.setStyleSheet("""
            QTextEdit {
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                padding: 12px;
                color: #2c3e50;
                background-color: #fafafa;
            }
        """)
        
        placeholder_text = "ë¸Œë¦¬í•‘ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...\n\nì´ ì‘ì—…ì€ ì¥ë©´ì˜ ë³µì¡ì„±ì— ë”°ë¼ ëª‡ ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        self.briefing_text.setPlaceholderText(placeholder_text)
        briefing_layout.addWidget(self.briefing_text)
        
        # ë¸Œë¦¬í•‘ ì»¨íŠ¸ë¡¤ ì„¹ì…˜
        briefing_controls = QHBoxLayout()
        
        # ì €ì¥ ë²„íŠ¼
        self.save_button = QPushButton(" ë¸Œë¦¬í•‘ ì €ì¥")
        self.save_button.setFont(QFont(self.korean_font, 11))
        self.save_button.setEnabled(False)
        self.save_button.clicked.connect(self.save_briefing)
        self.save_button.setCursor(Qt.PointingHandCursor)
        self.save_button.setStyleSheet("""
            QPushButton {
                background-color: #3498db;
                color: white;
                border-radius: 5px;
                padding: 8px 15px;
                font-weight: bold;
                border: none;
            }
            QPushButton:hover {
                background-color: #2980b9;
            }
            QPushButton:pressed {
                background-color: #1f6dad;
            }
            QPushButton:disabled {
                background-color: #bdc3c7;
            }
        """)
        
        # ë·° ì „í™˜ ë²„íŠ¼
        self.toggle_view_button = QPushButton("ğŸ”„ í…ìŠ¤íŠ¸ ë³´ê¸°")
        self.toggle_view_button.setFont(QFont(self.korean_font, 11))
        self.toggle_view_button.setEnabled(False)
        self.toggle_view_button.clicked.connect(self.toggle_view)
        self.toggle_view_button.setCursor(Qt.PointingHandCursor)
        self.toggle_view_button.setStyleSheet("""
            QPushButton {
                background-color: #95a5a6;
                color: white;
                border-radius: 5px;
                padding: 8px 15px;
                font-weight: bold;
                border: none;
            }
            QPushButton:hover {
                background-color: #7f8c8d;
            }
            QPushButton:pressed {
                background-color: #6c7778;
            }
            QPushButton:disabled {
                background-color: #bdc3c7;
            }
        """)
        
        # í°íŠ¸ í¬ê¸° ì¡°ì ˆ ë²„íŠ¼
        font_size_layout = QHBoxLayout()
        
        self.decrease_font_button = QPushButton("A-")
        self.decrease_font_button.setFixedSize(30, 30)
        self.decrease_font_button.clicked.connect(self.decrease_font)
        self.decrease_font_button.setCursor(Qt.PointingHandCursor)
        
        self.increase_font_button = QPushButton("A+")
        self.increase_font_button.setFixedSize(30, 30)
        self.increase_font_button.clicked.connect(self.increase_font)
        self.increase_font_button.setCursor(Qt.PointingHandCursor)
        
        font_size_layout.addWidget(self.decrease_font_button)
        font_size_layout.addWidget(self.increase_font_button)
        font_size_layout.setSpacing(5)
        
        briefing_controls.addWidget(self.save_button)
        briefing_controls.addWidget(self.toggle_view_button)
        briefing_controls.addStretch(1)
        briefing_controls.addLayout(font_size_layout)
        
        briefing_layout.addLayout(briefing_controls)
        left_layout.addWidget(briefing_container)
        
        # ===== ì˜¤ë¥¸ìª½ ì»¨í…Œì´ë„ˆ (QA ì„¹ì…˜) =====
        right_container = QWidget()
        right_layout = QVBoxLayout(right_container)
        right_layout.setContentsMargins(5, 0, 0, 0)
        right_layout.setSpacing(10)
        
        # QA ì„¹ì…˜ (ìš°ì¸¡)
        qa_container = QWidget()
        qa_container.setObjectName("qaContainer")
        qa_container.setStyleSheet("""
            #qaContainer {
                background-color: #ffffff;
                border-radius: 8px;
            }
        """)
        
        qa_shadow = QGraphicsDropShadowEffect()
        qa_shadow.setBlurRadius(10)
        qa_shadow.setColor(QColor(0, 0, 0, 40))
        qa_shadow.setOffset(0, 2)
        qa_container.setGraphicsEffect(qa_shadow)
        
        qa_layout = QVBoxLayout(qa_container)
        qa_layout.setContentsMargins(15, 15, 15, 15)
        qa_layout.setSpacing(10)
        
        # ì§ˆë¬¸-ë‹µë³€ ì„¹ì…˜ í—¤ë” ë ˆì´ì•„ì›ƒ
        qa_header_layout = QHBoxLayout()
        
        # ì§ˆë¬¸-ë‹µë³€ ì„¹ì…˜ íƒ€ì´í‹€
        qa_title = QLabel("ì‹¤ì‹œê°„ ì „íˆ¬ì§€íœ˜ì§€ì›")
        qa_title.setFont(QFont(self.korean_font, 14, QFont.Bold))
        qa_title.setStyleSheet("color: #2c3e50; margin-bottom: 5px;")
        qa_header_layout.addWidget(qa_title)
        
        qa_header_layout.addStretch(1)
        
        # ëª¨ë¸ ë ˆì´ë¸” ì œê±° (ë‚˜ì¤‘ì— ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™)
        # self.model_label = QLabel(f"ëª¨ë¸: {self.openai_model}")
        # self.model_label.setFont(QFont(self.korean_font, 10))
        # self.model_label.setStyleSheet("color: #7f8c8d; margin-right: 10px;")
        # qa_header_layout.addWidget(self.model_label)
        
        # API í‚¤ ì„¤ì • ë²„íŠ¼
        self.api_settings_button = QPushButton("API ì„¤ì •")
        self.api_settings_button.setFont(QFont(self.korean_font, 10))
        self.api_settings_button.setCursor(Qt.PointingHandCursor)
        self.api_settings_button.clicked.connect(self.show_api_settings)
        self.api_settings_button.setStyleSheet("""
            QPushButton {
                background-color: #7f8c8d;
                color: white;
                border-radius: 4px;
                padding: 4px 8px;
                font-weight: bold;
                border: none;
            }
            QPushButton:hover {
                background-color: #6c7778;
            }
        """)
        
        # ë‹µë³€ ë·° ì „í™˜ ë²„íŠ¼ (ë§ˆí¬ë‹¤ìš´/í…ìŠ¤íŠ¸)
        self.qa_toggle_view_button = QPushButton("ğŸ”„ í…ìŠ¤íŠ¸ ë³´ê¸°")
        self.qa_toggle_view_button.setFont(QFont(self.korean_font, 10))
        self.qa_toggle_view_button.setCursor(Qt.PointingHandCursor)
        self.qa_toggle_view_button.clicked.connect(self.toggle_qa_view)
        self.qa_toggle_view_button.setStyleSheet("""
            QPushButton {
                background-color: #3498db;
                color: white;
                border-radius: 4px;
                padding: 4px 8px;
                font-weight: bold;
                border: none;
            }
            QPushButton:hover {
                background-color: #2980b9;
            }
        """)
        
        # ë²„íŠ¼ë“¤ì„ ë‚˜ë€íˆ ë°°ì¹˜ (API ì„¤ì • ë²„íŠ¼ ì˜†ì— ë§ˆí¬ë‹¤ìš´/í…ìŠ¤íŠ¸ ì „í™˜ ë²„íŠ¼)
        qa_header_layout.addWidget(self.api_settings_button)
        qa_header_layout.addWidget(self.qa_toggle_view_button)
        
        qa_layout.addLayout(qa_header_layout)
        
        # ì§ˆë¬¸-ë‹µë³€ ê¸°ë¡ ì˜ì—­
        self.qa_history = QTextEdit()
        self.qa_history.setFont(QFont(self.korean_font, 11))
        self.qa_history.setReadOnly(True)
        self.qa_history.setAcceptRichText(True)
        self.qa_history.setStyleSheet("""
            QTextEdit {
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                padding: 10px;
                color: #2c3e50;
                background-color: #f5f5f5;
            }
        """)
        self.qa_history.setPlaceholderText("ì—¬ê¸°ì— ì§ˆë¬¸ê³¼ ë‹µë³€ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤. ë¸Œë¦¬í•‘ì´ ì™„ë£Œëœ í›„ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        qa_layout.addWidget(self.qa_history)
        
        # ì§ˆë¬¸ ì…ë ¥ ë° ì œì¶œ ì˜ì—­
        question_layout = QHBoxLayout()
        
        self.question_input = QTextEdit()
        self.question_input.setFont(QFont(self.korean_font, 11))
        self.question_input.setAcceptRichText(False)
        self.question_input.setStyleSheet("""
            QTextEdit {
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                padding: 10px;
                color: #2c3e50;
                background-color: #ffffff;
            }
        """)
        self.question_input.setPlaceholderText("ê³µê°„ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”... ì‹œê°í™”ê°€ í•„ìš”í•œ ê²½ìš° ìš”ì²­ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
        self.question_input.setMaximumHeight(80)
        self.question_input.setEnabled(False)
        
        self.submit_question_button = QPushButton("ì§ˆë¬¸í•˜ê¸°")
        self.submit_question_button.setEnabled(False)
        self.submit_question_button.setFont(QFont(self.korean_font, 11))
        self.submit_question_button.setCursor(Qt.PointingHandCursor)
        self.submit_question_button.setStyleSheet("""
            QPushButton {
                background-color: #2ecc71;
                color: white;
                border-radius: 5px;
                padding: 8px 15px;
                font-weight: bold;
                border: none;
                min-width: 100px;
            }
            QPushButton:hover {
                background-color: #27ae60;
            }
            QPushButton:pressed {
                background-color: #1e8449;
            }
            QPushButton:disabled {
                background-color: #bdc3c7;
            }
        """)
        self.submit_question_button.clicked.connect(self.submit_question)
        self.submit_question_button.setEnabled(False)
        
        question_layout.addWidget(self.question_input, 4)
        question_layout.addWidget(self.submit_question_button, 1)
        
        qa_layout.addLayout(question_layout)
        
        # ëª¨ë¸ ë ˆì´ë¸” ì¶”ê°€ - ì§ˆë¬¸ ì…ë ¥ì¹¸ ì•„ë˜ì— ë°°ì¹˜
        self.model_label = QLabel(f"ëª¨ë¸: {self.openai_model}")
        self.model_label.setFont(QFont(self.korean_font, 10))
        self.model_label.setStyleSheet("color: #7f8c8d; margin-top: 5px;")
        qa_layout.addWidget(self.model_label)
        
        right_layout.addWidget(qa_container)
        
        # ìŠ¤í”Œë¦¬í„°ì— ì¢Œìš° ì»¨í…Œì´ë„ˆ ì¶”ê°€
        splitter.addWidget(left_container)
        splitter.addWidget(right_container)
        
        # ì´ˆê¸° ë¶„í•  ë¹„ìœ¨ ì„¤ì • (50:50)
        splitter.setSizes([int(self.width() * 0.5), int(self.width() * 0.5)])
        
        # ë©”ì¸ ë ˆì´ì•„ì›ƒì— ìŠ¤í”Œë¦¬í„° ì¶”ê°€
        main_layout.addWidget(splitter)
        
        # ë©”ì¸ ìœ„ì ¯ ì„¤ì •
        self.setCentralWidget(main_widget)
        
        # ë§ˆí¬ë‹¤ìš´ CSS ì„¤ì •
        self.markdown_css = """
        <style>
            body {
                font-family: "{}";
                line-height: 1.4;
                color: #2c3e50;
                padding: 0;
                margin: 0;
            }
            h1, h2, h3, h4, h5, h6 {
                color: #34495e;
                margin-top: 16px;
                margin-bottom: 12px;
                font-weight: 600;
            }
            h1 { font-size: 1.8em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
            h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
            h3 { font-size: 1.3em; }
            p { margin-bottom: 12px; }
            ul, ol { padding-left: 2em; margin-bottom: 12px; margin-top: 6px; }
            li { margin-bottom: 0.2em; }
            table {
                border-collapse: collapse;
                margin-bottom: 16px;
                width: 100%;
            }
            th, td {
                border: 1px solid #dfe2e5;
                padding: 6px 13px;
            }
            th {
                background-color: #f6f8fa;
            }
            code {
                font-family: "Courier New", Courier, monospace;
                background-color: #f6f8fa;
                padding: 0.2em 0.4em;
                border-radius: 3px;
            }
            pre {
                background-color: #f6f8fa;
                padding: 16px;
                border-radius: 3px;
                overflow: auto;
            }
            pre code {
                background-color: transparent;
                padding: 0;
            }
            blockquote {
                margin-left: 0;
                padding-left: 1em;
                border-left: 4px solid #dfe2e5;
                color: #6a737d;
            }
            hr {
                height: 0.25em;
                padding: 0;
                margin: 24px 0;
                background-color: #e1e4e8;
                border: 0;
            }
            .question {
                background-color: #f0f8ff;
                border-left: 4px solid #3498db;
                padding: 10px;
                margin-bottom: 15px;
            }
            .answer {
                background-color: #f7fdfa;
                border-left: 4px solid #2ecc71;
                padding: 10px;
                margin-bottom: 15px;
            }
        </style>
        """
        
        # ìƒíƒœë°” ì¶”ê°€
        self.statusBar = QStatusBar()
        self.setStatusBar(self.statusBar)
        self.statusBar.showMessage("ì¤€ë¹„ ì™„ë£Œ")
        
        # ë§ˆí¬ë‹¤ìš´ ë·° ì„¤ì •
        self.markdown_view = True
        self.qa_markdown_view = True
        
        # ì°½ í‘œì‹œ
        self.show()

    def create_default_icon(self):
        """ê¸°ë³¸ ì•„ì´ì½˜ ìƒì„±"""
        # í”½ì…€ ì•„íŠ¸ ìŠ¤íƒ€ì¼ì˜ ê°„ë‹¨í•œ ì•„ì´ì½˜ ìƒì„±
        pixmap = QPixmap(32, 32)
        pixmap.fill(Qt.transparent)
        
        # ì•„ì´ì½˜ ê·¸ë¦¬ê¸°
        painter = QPainter(pixmap)
        painter.setRenderHint(QPainter.Antialiasing)
        
        # ë°°ê²½ ì› ê·¸ë¦¬ê¸°
        painter.setPen(Qt.NoPen)
        painter.setBrush(QBrush(QColor(52, 152, 219)))  # íŒŒë€ìƒ‰ ë°°ê²½
        painter.drawEllipse(2, 2, 28, 28)
        
        # ê°„ë‹¨í•œ ì§€ë„/ë ˆì´ì•„ì›ƒ ì•„ì´ì½˜ ê·¸ë¦¬ê¸°
        painter.setPen(QPen(QColor(255, 255, 255), 2))  # í°ìƒ‰ ì„ 
        painter.drawLine(10, 10, 22, 10)  # ìƒë‹¨ ì„ 
        painter.drawLine(10, 16, 22, 16)  # ì¤‘ê°„ ì„ 
        painter.drawLine(10, 22, 22, 22)  # í•˜ë‹¨ ì„ 
        
        painter.drawLine(8, 8, 8, 24)     # ì™¼ìª½ ì„¸ë¡œì„ 
        painter.drawLine(24, 8, 24, 24)   # ì˜¤ë¥¸ìª½ ì„¸ë¡œì„ 
        
        # ê·¸ë¦¬ê¸° ì¢…ë£Œ
        painter.end()
        
        # QIcon ê°ì²´ ìƒì„±í•˜ì—¬ ë°˜í™˜
        return QIcon(pixmap)

    def apply_modern_style(self):
        """ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëª¨ë˜í•œ ìŠ¤íƒ€ì¼ ì ìš©"""
        self.setStyleSheet("""
            QMainWindow {
                background-color: #f5f6fa;
            }
            
            QLabel {
                color: #2c3e50;
            }
            
            QPushButton {
                border-radius: 4px;
                padding: 8px 15px;
                background-color: #3498db;
                color: white;
                font-weight: bold;
            }
            
            QPushButton:hover {
                background-color: #2980b9;
            }
            
            QPushButton:disabled {
                background-color: #bdc3c7;
                color: #7f8c8d;
            }
            
            QComboBox {
                border: 1px solid #dcdde1;
                border-radius: 4px;
                padding: 5px;
                background-color: white;
            }
            
            QTextEdit {
                background-color: white;
                border: 1px solid #dcdde1;
                border-radius: 4px;
            }
            
            QProgressBar {
                text-align: center;
                background-color: #f0f0f0;
                border-radius: 4px;
                height: 10px;
            }
            
            QProgressBar::chunk {
                background-color: #3498db;
                border-radius: 4px;
            }
        """)

    def start_briefing_generation(self):
        """ë¸Œë¦¬í•‘ ìƒì„± ìŠ¤ë ˆë“œ ì‹œì‘"""
        # API í‚¤ í™•ì¸
        if not self.openai_api_key:
            # API í‚¤ê°€ ì—†ìœ¼ë©´ ì„¤ì • ëŒ€í™” ìƒì í‘œì‹œ
            self.show_api_settings()
            if not self.openai_api_key:
                QMessageBox.warning(self, "API í‚¤ í•„ìš”", "ë¸Œë¦¬í•‘ì„ ìƒì„±í•˜ë ¤ë©´ OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
                self.status_label.setText("ë¸Œë¦¬í•‘ ìƒì„± ì·¨ì†Œë¨ - API í‚¤ ì—†ìŒ")
                self.progress_bar.setValue(0)
                return
        
        # ChatGPTë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸Œë¦¬í•‘ ìƒì„±
        self.briefing_thread = ChatGPTBriefingThread(
            self.layout_file, 
            self.tmp_briefing_file, 
            self.model_path, 
            self.openai_api_key,
            self.openai_model,
            self.language
        )
        
        # ë¸Œë¦¬í•‘ ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ì„ ìœ„í•œ ë³€ìˆ˜ ì´ˆê¸°í™”
        self.streaming_briefing_text = ""
        self.is_briefing_streaming = True
        
        self.status_label.setText("ChatGPTë¡œ ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...")
            
        self.briefing_thread.update_signal.connect(self.update_briefing_content)
        self.briefing_thread.finished_signal.connect(self.briefing_completed)
        self.briefing_thread.error_signal.connect(self.briefing_error)
        self.briefing_thread.progress_signal.connect(self.update_progress)
        
        # ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì‹œê·¸ë„ ì—°ê²°
        self.briefing_thread.stream_signal.connect(self.update_streaming_briefing)
            
        self.briefing_thread.start()

    def start_rerun_viewer(self):
        """Rerun ë·°ì–´ ìŠ¤ë ˆë“œ ì‹œì‘"""
        self.rerun_thread = RerunViewerThread(self.rrd_file)
        self.rerun_thread.error_signal.connect(self.rerun_error)
        self.rerun_thread.start()

    def update_briefing_content(self, text):
        """ë¸Œë¦¬í•‘ ë‚´ìš© ì—…ë°ì´íŠ¸"""
        if text:
            # í…ìŠ¤íŠ¸ ì €ì¥
            self.markdown_content = text
            
            # ìƒíƒœ ì—…ë°ì´íŠ¸
            self.status_label.setText("ë¸Œë¦¬í•‘ ìƒì„± ì™„ë£Œ!")
            self.progress_bar.setValue(100)
            
            # ë²„íŠ¼ í™œì„±í™”
            self.save_button.setEnabled(True)
            self.toggle_view_button.setEnabled(True)
            
            # ì§ˆë¬¸ ì…ë ¥ í™œì„±í™”
            self.question_input.setEnabled(True)
            self.submit_question_button.setEnabled(True)
            
            # ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
            if self.markdown_view:
                self.render_markdown()
            else:
                self.briefing_text.setPlainText(text)
                
            # QA íˆìŠ¤í† ë¦¬ ë³µì› (í•­ìƒ ë³µì›)
            self.restore_qa_history()
        else:
            # ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            error_html = """
            <div style="text-align:center; padding:20px; color:#e74c3c;">
                <h3>ë¸Œë¦¬í•‘ ìƒì„± ì‹¤íŒ¨</h3>
                <p>ë¸Œë¦¬í•‘ ë‚´ìš©ì„ ìƒì„±í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <p>ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë‹¤ë¥¸ RRD íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            </div>
            """
            self.briefing_text.setHtml(error_html)
            self.status_label.setText("ë¸Œë¦¬í•‘ ìƒì„± ì‹¤íŒ¨")
            self.progress_bar.setValue(0)

    def briefing_completed(self, content):
        """ë¸Œë¦¬í•‘ ìƒì„± ì™„ë£Œ ì²˜ë¦¬"""
        # ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ
        self.is_briefing_streaming = False
        
        # ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸  ì €ì¥
        self.markdown_content = content
        
        # ìƒíƒœ ì—…ë°ì´íŠ¸
        self.status_label.setText("ë¸Œë¦¬í•‘ ìƒì„± ì™„ë£Œ!")
        self.progress_bar.setValue(100)
        
        # ë²„íŠ¼ í™œì„±í™”
        self.save_button.setEnabled(True)
        self.toggle_view_button.setEnabled(True)
        
        # ì§ˆë¬¸ ì…ë ¥ í™œì„±í™”
        self.question_input.setEnabled(True)
        self.submit_question_button.setEnabled(True)
        
        # ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ (ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì— ì´ë¯¸ ë Œë”ë§ëœ ê²½ìš°ì—ë„ ìµœì¢… ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ë Œë”ë§)
        if self.markdown_view:
            self.render_markdown()
        else:
            self.briefing_text.setPlainText(content)
            
        # QA íˆìŠ¤í† ë¦¬ ë³µì›
        self.restore_qa_history()

    def briefing_error(self, error):
        """ë¸Œë¦¬í•‘ ìƒì„± ì˜¤ë¥˜"""
        self.progress_bar.setValue(0)
        self.status_label.setText("ë¸Œë¦¬í•‘ ìƒì„± ì˜¤ë¥˜")
        
        self.briefing_text.clear()
        self.briefing_text.setText(f"ë¸Œë¦¬í•‘ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n{error}\n\në ˆì´ì•„ì›ƒ íŒŒì¼ì´ ì˜¬ë°”ë¥´ê³  ìœ íš¨í•œì§€ í™•ì¸í•˜ì„¸ìš”.")
        
        QMessageBox.critical(self, "ì˜¤ë¥˜", f"ë¸Œë¦¬í•‘ ìƒì„± ì˜¤ë¥˜: {error}")

    def rerun_error(self, error):
        """Rerun ë·°ì–´ ì‹¤í–‰ ì˜¤ë¥˜"""
        QMessageBox.warning(self, "ê²½ê³ ", f"Rerun ë·°ì–´ ì‹¤í–‰ ì˜¤ë¥˜: {error}")

    def update_progress(self, value):
        """ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸"""
        self.progress_bar.setValue(value)
        
        # ì§„í–‰ ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        if value < 25:
            msg = "ì¥ë©´ ë¶„ì„ ì¤‘..."
        elif value < 50:
            msg = "ê°ì²´ ì •ë³´ ì²˜ë¦¬ ì¤‘..."
        elif value < 75:
            msg = "ë¸Œë¦¬í•‘ ì´ˆì•ˆ ìƒì„± ì¤‘..."
        else:
            msg = "ìµœì¢… ë¸Œë¦¬í•‘ ì™„ì„± ì¤‘..."
            
        self.status_label.setText(msg)

    def convert_markdown_to_html(self, md_text):
        """ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë³€í™˜"""
        try:
            # ë§ˆí¬ë‹¤ìš´ í™•ì¥ ì˜µì…˜ ì„¤ì •
            extensions = [
                'markdown.extensions.tables',
                'markdown.extensions.fenced_code',
                'markdown.extensions.codehilite',
                'markdown.extensions.nl2br',
                'markdown.extensions.sane_lists'
            ]
            
            # ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
            html = markdown.markdown(md_text, extensions=extensions)
            
            # CSSì— í°íŠ¸ ì´ë¦„ ì§ì ‘ ì ìš©
            css_with_font = self.markdown_css.replace("{}", self.korean_font)
            
            # ìµœì¢… HTML ë¬¸ì„œ ìƒì„± (CSS ìŠ¤íƒ€ì¼ í¬í•¨)
            complete_html = f"""
            <html>
                <head>
                    {css_with_font}
                </head>
                <body>
                    {html}
                </body>
            </html>
            """
            
            return complete_html
        except Exception as e:
            print(f"ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì˜¤ë¥˜: {str(e)}")
            return f"<p>ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì˜¤ë¥˜: {str(e)}</p><pre>{md_text}</pre>"

    def render_markdown(self):
        """ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ ë Œë”ë§í•˜ì—¬ í‘œì‹œ"""
        if not hasattr(self, 'markdown_content') or not self.markdown_content:
            return
            
        # í˜„ì¬ í°íŠ¸ ì´ë¦„ê³¼ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
        font = self.briefing_text.font()
        font_name = font.family()
        font_size = font.pointSize()
        
        # ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
        html_content = markdown.markdown(
            self.markdown_content, 
            extensions=['tables', 'fenced_code', 'codehilite', 'nl2br', 'sane_lists']
        )
        
        # CSSì— í°íŠ¸ ì§ì ‘ ì§€ì •
        css = self.markdown_css.replace('"{}"', f'"{font_name}"')
        
        # HTML ì„¤ì •
        self.briefing_text.setHtml(css + html_content)
        
        # ì§ˆë¬¸-ë‹µë³€ íˆìŠ¤í† ë¦¬ ë³µì›
        self.restore_qa_history()

    def toggle_view(self):
        """ë§ˆí¬ë‹¤ìš´ ë·°ì™€ ì¼ë°˜ í…ìŠ¤íŠ¸ ë·° ì „í™˜"""
        if self.markdown_view:
            # ë§ˆí¬ë‹¤ìš´ â†’ í…ìŠ¤íŠ¸ ì „í™˜
            self.markdown_view = False
            self.toggle_view_button.setText("ğŸ”„ ë§ˆí¬ë‹¤ìš´ ë³´ê¸°")
            self.briefing_text.setPlainText(self.markdown_content)
        else:
            # í…ìŠ¤íŠ¸ â†’ ë§ˆí¬ë‹¤ìš´ ì „í™˜
            self.markdown_view = True
            self.toggle_view_button.setText("ğŸ”„ í…ìŠ¤íŠ¸ ë³´ê¸°")
            self.render_markdown()

    def save_briefing(self):
        """ë¸Œë¦¬í•‘ ì €ì¥"""
        try:
            # íŒŒì¼ ì €ì¥ ëŒ€í™”ìƒì
            options = QFileDialog.Options()
            
            # ì €ì¥ í˜•ì‹ ì„ íƒ (ë§ˆí¬ë‹¤ìš´/HTML/í…ìŠ¤íŠ¸)
            file_filter = "ë§ˆí¬ë‹¤ìš´ íŒŒì¼ (*.md);;HTML íŒŒì¼ (*.html);;í…ìŠ¤íŠ¸ íŒŒì¼ (*.txt)"
            default_filename = f"{self.basename}_briefing.md" if self.markdown_view else f"{self.basename}_briefing.txt"
            
            file_path, selected_filter = QFileDialog.getSaveFileName(
                self, "ë¸Œë¦¬í•‘ ì €ì¥", default_filename, 
                file_filter, options=options
            )
            
            if file_path:
                if selected_filter == "HTML íŒŒì¼ (*.html)":
                    # HTMLë¡œ ì €ì¥
                    html_content = self.convert_markdown_to_html(self.markdown_content)
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write(html_content)
                elif selected_filter == "ë§ˆí¬ë‹¤ìš´ íŒŒì¼ (*.md)":
                    # ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì €ì¥
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write(self.markdown_content)
                else:
                    # ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì €ì¥
                    with open(file_path, 'w', encoding='utf-8') as f:
                        f.write(self.markdown_content)
                
                QMessageBox.information(self, "ì €ì¥ ì™„ë£Œ", f"ë¸Œë¦¬í•‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {file_path}")
        except Exception as e:
            QMessageBox.critical(self, "ì €ì¥ ì˜¤ë¥˜", f"íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")

    def increase_font(self):
        """í°íŠ¸ í¬ê¸° ì¦ê°€"""
        current_font = self.briefing_text.font()
        size = current_font.pointSize()
        if size < 24:  # ìµœëŒ€ í¬ê¸° ì œí•œ
            current_font.setPointSize(size + 1)
            self.briefing_text.setFont(current_font)
            # ë§ˆí¬ë‹¤ìš´ ë·°ì¼ ê²½ìš° ë‹¤ì‹œ ë Œë”ë§
            if self.markdown_view and hasattr(self, 'markdown_content') and self.markdown_content:
                self.render_markdown()
    
    def decrease_font(self):
        """í°íŠ¸ í¬ê¸° ê°ì†Œ"""
        current_font = self.briefing_text.font()
        size = current_font.pointSize()
        if size > 8:  # ìµœì†Œ í¬ê¸° ì œí•œ
            current_font.setPointSize(size - 1)
            self.briefing_text.setFont(current_font)
            # ë§ˆí¬ë‹¤ìš´ ë·°ì¼ ê²½ìš° ë‹¤ì‹œ ë Œë”ë§
            if self.markdown_view and hasattr(self, 'markdown_content') and self.markdown_content:
                self.render_markdown()

    def change_language(self, index):
        """ì–¸ì–´ ë³€ê²½"""
        new_language = "korean" if index == 0 else "english"
        if new_language != self.language:
            reply = QMessageBox.question(self, "ì–¸ì–´ ë³€ê²½", 
                                        "ì–¸ì–´ë¥¼ ë³€ê²½í•˜ë©´ ë¸Œë¦¬í•‘ì´ ë‹¤ì‹œ ìƒì„±ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                                        QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
            if reply == QMessageBox.Yes:
                self.language = new_language
                self.progress_bar.setValue(0)
                self.status_label.setText("ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...")
                self.briefing_text.clear()
                self.briefing_text.setPlaceholderText("ë¸Œë¦¬í•‘ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...")
                self.save_button.setEnabled(False)
                
                # ë¸Œë¦¬í•‘ ë‹¤ì‹œ ìƒì„±
                self.start_briefing_generation()
            else:
                # ë³€ê²½ ì·¨ì†Œ
                self.language_combo.setCurrentIndex(0 if self.language == "korean" else 1)

    def closeEvent(self, event):
        """ì°½ ë‹«ê¸° ì´ë²¤íŠ¸"""
        # ì„ì‹œ íŒŒì¼ ì‚­ì œ
        try:
            if os.path.exists(self.tmp_briefing_file):
                os.unlink(self.tmp_briefing_file)
        except:
            pass
        
        # ê¸°ë³¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
        super().closeEvent(event)

    def show_api_settings(self):
        """API ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ"""
        dialog = ApiKeyDialog(self, self.openai_api_key)
        
        # í˜„ì¬ ëª¨ë¸ ì„ íƒ
        model_index = dialog.model_combo.findText(self.openai_model)
        if model_index >= 0:
            dialog.model_combo.setCurrentIndex(model_index)
        
        if dialog.exec_() == QDialog.Accepted:
            # ìƒˆ ì„¤ì • ì €ì¥
            self.openai_api_key = dialog.get_api_key()
            self.openai_model = dialog.get_model()
            self.save_api_config()
            
            # ëª¨ë¸ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
            self.model_label.setText(f"ëª¨ë¸: {self.openai_model}")
            
            api_status = "API í‚¤ê°€ ì„¤ì •ë¨" if self.openai_api_key else "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
            self.statusBar.showMessage(f"API ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ({api_status})")
    
    def load_api_config(self):
        """API ì„¤ì • ë¡œë“œ"""
        try:
            # ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
            if not os.path.exists(self.config_dir):
                os.makedirs(self.config_dir)
            
            # ì„¤ì • íŒŒì¼ ë¡œë“œ
            if os.path.exists(self.config_file):
                config = configparser.ConfigParser()
                config.read(self.config_file)
                
                if 'OpenAI' in config:
                    self.openai_api_key = config['OpenAI'].get('api_key', '')
                    self.openai_model = config['OpenAI'].get('model', 'gpt-4')
                    
                    # ëª¨ë¸ ë ˆì´ë¸”ì´ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    if hasattr(self, 'model_label'):
                        self.model_label.setText(f"ëª¨ë¸: {self.openai_model}")
        except Exception as e:
            print(f"ì„¤ì • ë¡œë“œ ì˜¤ë¥˜: {str(e)}")
    
    def save_api_config(self):
        """API ì„¤ì • ì €ì¥"""
        try:
            # ì„¤ì • ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
            if not os.path.exists(self.config_dir):
                os.makedirs(self.config_dir)
            
            # ì„¤ì • íŒŒì¼ ì €ì¥
            config = configparser.ConfigParser()
            config['OpenAI'] = {
                'api_key': self.openai_api_key,
                'model': self.openai_model
            }
            
            with open(self.config_file, 'w') as f:
                config.write(f)
                
            print(f"API ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {self.config_file}")
        except Exception as e:
            print(f"ì„¤ì • ì €ì¥ ì˜¤ë¥˜: {str(e)}")
            
    def show_qa_error(self, error):
        """ì§ˆë¬¸-ë‹µë³€ ì˜¤ë¥˜ í‘œì‹œ"""
        # ì˜¤ë¥˜ ë©”ì‹œì§€ HTML ìƒì„±
        error_html = f"""<div style="color: #e74c3c; margin: 10px 0;"><strong>âš ï¸ ì˜¤ë¥˜:</strong> {error}</div>"""
        
        # ì˜¤ë¥˜ ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
        self.qa_history.append(error_html)
        
        # íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ì— ì˜¤ë¥˜ ì €ì¥
        self.qa_history_list.append({
            "type": "error",
            "content": error,
            "timestamp": datetime.now().strftime("%H:%M:%S"),
            "html": error_html
        })
        
        # UI ë‹¤ì‹œ í™œì„±í™”
        self.question_input.setEnabled(True)
        self.submit_question_button.setEnabled(True)
        self.submit_question_button.setText("ì§ˆë¬¸í•˜ê¸°")
        self.statusBar.showMessage("ì§ˆë¬¸ ì²˜ë¦¬ ì˜¤ë¥˜")
        
        # íˆìŠ¤í† ë¦¬ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
        self.qa_history.verticalScrollBar().setValue(
            self.qa_history.verticalScrollBar().maximum()
        )

    def submit_question(self):
        """ì§ˆë¬¸ ì œì¶œ ë° ì²˜ë¦¬"""
        # ì§ˆë¬¸ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        question = self.question_input.toPlainText().strip()
        
        # ì§ˆë¬¸ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
        if not question:
            self.statusBar.showMessage("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
        
        # API í‚¤ í™•ì¸
        if not self.openai_api_key:
            reply = QMessageBox.question(
                self, "API í‚¤ í•„ìš”", 
                "ì§ˆë¬¸ì— ë‹µë³€í•˜ë ¤ë©´ OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. API ì„¤ì • ì°½ì„ ì—¬ì‹œê² ìŠµë‹ˆê¹Œ?",
                QMessageBox.Yes | QMessageBox.No, QMessageBox.Yes
            )
            if reply == QMessageBox.Yes:
                self.show_api_settings()
                return
        
        # UI ìƒíƒœ ì—…ë°ì´íŠ¸
        self.question_input.setEnabled(False)
        self.submit_question_button.setEnabled(False)
        self.submit_question_button.setText("ì²˜ë¦¬ ì¤‘...")
        self.statusBar.showMessage("ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘...")
        
        # íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        timestamp = datetime.now().strftime("%H:%M:%S")
        
        # íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ì— ì§ˆë¬¸ ì €ì¥
        self.qa_history_list.append({
            "type": "question",
            "content": question,
            "timestamp": timestamp
        })
        
        # íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ì— ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì¤€ë¹„
        self.qa_history_list.append({
            "type": "streaming",
            "content": "ì‘ë‹µì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...",
            "timestamp": datetime.now().strftime("%H:%M:%S")
        })
        
        # ë§ˆí¬ë‹¤ìš´/í…ìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë Œë”ë§
        if hasattr(self, 'qa_markdown_view') and self.qa_markdown_view:
            self.render_qa_history()
        else:
            # í…ìŠ¤íŠ¸ ëª¨ë“œ
            plain_text = ""
            for item in self.qa_history_list:
                if item["type"] == "question":
                    plain_text += f"ì§ˆë¬¸: {item['content']}\n\n"
                elif item["type"] == "answer":
                    plain_text += f"ë‹µë³€: {item['content']}\n\n"
                elif item["type"] == "streaming":
                    plain_text += f"ë‹µë³€ ì¤‘...\n{item['content']}\n\n"
                elif item["type"] == "error":
                    plain_text += f"ì˜¤ë¥˜: {item['content']}\n\n"
            
            self.qa_history.setPlainText(plain_text)
        
        # íˆìŠ¤í† ë¦¬ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
        self.qa_history.verticalScrollBar().setValue(
            self.qa_history.verticalScrollBar().maximum()
        )
        
        # í˜„ì¬ê¹Œì§€ì˜ ë¸Œë¦¬í•‘ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        if hasattr(self, 'markdown_content'):
            briefing_content = self.markdown_content
        else:
            briefing_content = self.briefing_text.toPlainText()
        
        # ìŠ¤íŠ¸ë¦¬ë° ë³€ìˆ˜ ì´ˆê¸°í™”
        self.streaming_answer = ""
        self.is_answer_streaming = True
        
        # ChatGPT API í˜¸ì¶œ ì“°ë ˆë“œ ì‹œì‘
        self.qa_thread = QAThread(
            self.layout_file,
            briefing_content,
            question,
            self.openai_api_key,
            self.openai_model,
            self.language
        )
        
        # ì‹œê·¸ë„ ì—°ê²°
        self.qa_thread.answer_signal.connect(self.show_answer)
        self.qa_thread.error_signal.connect(self.show_qa_error)
        self.qa_thread.stream_signal.connect(self.update_streaming_answer)
        self.qa_thread.code_generated_signal.connect(self.handle_generated_code)  # ìƒˆë¡œìš´ ì‹œê·¸ë„ ì—°ê²°
        
        # ì“°ë ˆë“œ ì‹œì‘
        self.qa_thread.start()
        
        # ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        self.question_input.clear()
    
    def update_streaming_answer(self, text_chunk):
        """ë‹µë³€ ìŠ¤íŠ¸ë¦¬ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸"""
        # íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        escaped_chunk = text_chunk.replace("<", "&lt;").replace(">", "&gt;")
        
        # í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ì— ì¶”ê°€
        self.streaming_answer += escaped_chunk
        
        # ë§ˆí¬ë‹¤ìš´/í…ìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì—…ë°ì´íŠ¸
        if hasattr(self, 'qa_markdown_view') and self.qa_markdown_view:
            # ìŠ¤íŠ¸ë¦¬ë° ë‚´ìš©ì„ ë§ˆì§€ë§‰ í•­ëª©ìœ¼ë¡œ ì„ì‹œ ì €ì¥
            if len(self.qa_history_list) > 0 and self.qa_history_list[-1]["type"] == "streaming":
                # ê¸°ì¡´ ìŠ¤íŠ¸ë¦¬ë° í•­ëª© ì—…ë°ì´íŠ¸
                self.qa_history_list[-1]["content"] = self.streaming_answer
            else:
                # ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¬ë° í•­ëª© ì¶”ê°€
                self.qa_history_list.append({
                    "type": "streaming", 
                    "content": self.streaming_answer,
                    "timestamp": datetime.now().strftime("%H:%M:%S")
                })
            
            # ì „ì²´ íˆìŠ¤í† ë¦¬ ë‹¤ì‹œ ë Œë”ë§
            self.render_qa_history()
        else:
            # í…ìŠ¤íŠ¸ ëª¨ë“œ
            # í˜„ì¬ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            plain_text = ""
            for item in self.qa_history_list:
                if item["type"] == "question":
                    plain_text += f"ì§ˆë¬¸: {item['content']}\n\n"
                elif item["type"] == "answer":
                    plain_text += f"ë‹µë³€: {item['content']}\n\n"
                elif item["type"] == "error":
                    plain_text += f"ì˜¤ë¥˜: {item['content']}\n\n"
            
            # í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ì‘ë‹µ ì¶”ê°€
            plain_text += f"ë‹µë³€ ì¤‘...\n{self.streaming_answer}\n"
            
            # í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            self.qa_history.setPlainText(plain_text)
        
        # ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ìœ ì§€
        self.qa_history.verticalScrollBar().setValue(
            self.qa_history.verticalScrollBar().maximum()
        )

    def show_answer(self, answer):
        """ìµœì¢… ë‹µë³€ í‘œì‹œ ë° ë§ˆí¬ë‹¤ìš´ ì ìš©"""
        # ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ ì¢…ë£Œ
        self.is_answer_streaming = False
        
        try:
            # ì‘ë‹µ ì‹œê°„ ê¸°ë¡
            timestamp = datetime.now().strftime("%H:%M:%S")
            
            # ìŠ¤íŠ¸ë¦¬ë° í•­ëª© ì œê±° (ìˆëŠ” ê²½ìš°)
            for i in range(len(self.qa_history_list) - 1, -1, -1):
                if self.qa_history_list[i]["type"] == "streaming":
                    del self.qa_history_list[i]
                    break
            
            # íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ì— ë‹µë³€ ì €ì¥
            self.qa_history_list.append({
                "type": "answer",
                "content": answer,
                "timestamp": timestamp
            })
            
            # ë§ˆí¬ë‹¤ìš´/í…ìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë Œë”ë§
            if hasattr(self, 'qa_markdown_view') and self.qa_markdown_view:
                # ë§ˆí¬ë‹¤ìš´ ëª¨ë“œ - ì „ì²´ íˆìŠ¤í† ë¦¬ ë‹¤ì‹œ ë Œë”ë§
                self.render_qa_history()
            else:
                # í…ìŠ¤íŠ¸ ëª¨ë“œ
                # í˜„ì¬ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                plain_text = ""
                for item in self.qa_history_list:
                    if item["type"] == "question":
                        plain_text += f"ì§ˆë¬¸: {item['content']}\n\n"
                    elif item["type"] == "answer":
                        plain_text += f"ë‹µë³€: {item['content']}\n\n"
                    elif item["type"] == "error":
                        plain_text += f"ì˜¤ë¥˜: {item['content']}\n\n"
                
                # í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                self.qa_history.setPlainText(plain_text)
            
            # UI ë‹¤ì‹œ í™œì„±í™”
            self.question_input.setEnabled(True)
            self.submit_question_button.setEnabled(True)
            self.submit_question_button.setText("ì§ˆë¬¸í•˜ê¸°")
            self.statusBar.showMessage("ë‹µë³€ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            # íˆìŠ¤í† ë¦¬ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
            self.qa_history.verticalScrollBar().setValue(
                self.qa_history.verticalScrollBar().maximum()
            )
        except Exception as e:
            # ì˜¤ë¥˜ ì²˜ë¦¬
            self.show_qa_error(f"ë‹µë³€ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")

    def restore_qa_history(self):
        """ì €ì¥ëœ ì§ˆë¬¸-ë‹µë³€ íˆìŠ¤í† ë¦¬ ë³µì›"""
        if not self.qa_history_list:
            return
            
        # ê¸°ì¡´ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
        self.qa_history.clear()
        
        # ì €ì¥ëœ íˆìŠ¤í† ë¦¬ ìˆœì°¨ì ìœ¼ë¡œ ì¶”ê°€
        for item in self.qa_history_list:
            if item.get("markdown", False) and item["type"] == "answer":
                # ë§ˆí¬ë‹¤ìš´ ë³€í™˜ëœ ë‹µë³€
                self.qa_history.append(item["html"])
            else:
                # ì¼ë°˜ ì§ˆë¬¸ ë° ì˜¤ë¥˜
                self.qa_history.append(item["html"])
        
        # ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
        self.qa_history.verticalScrollBar().setValue(
            self.qa_history.verticalScrollBar().maximum()
        )

    def update_streaming_briefing(self, text_chunk):
        """ë¸Œë¦¬í•‘ ìŠ¤íŠ¸ë¦¬ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸"""
        # ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ì„ ìœ„í•´ í…ìŠ¤íŠ¸ ëˆ„ì 
        self.streaming_briefing_text += text_chunk
        
        # ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
        if self.is_briefing_streaming:
            if self.markdown_view:
                # ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                try:
                    html_content = markdown.markdown(
                        self.streaming_briefing_text, 
                        extensions=['tables', 'fenced_code', 'codehilite']
                    )
                    
                    # í˜„ì¬ í°íŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                    font = self.briefing_text.font()
                    font_name = font.family()
                    
                    # CSS ì ìš©
                    css = self.markdown_css.replace('"{}"', f'"{font_name}"')
                    
                    # HTML ì„¤ì •
                    self.briefing_text.setHtml(css + html_content)
                except Exception as e:
                    # ë§ˆí¬ë‹¤ìš´ ë³€í™˜ ì˜¤ë¥˜ ì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                    self.briefing_text.setPlainText(self.streaming_briefing_text)
            else:
                # í…ìŠ¤íŠ¸ ëª¨ë“œì¼ ê²½ìš° ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                self.briefing_text.setPlainText(self.streaming_briefing_text)
            
            # ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ìœ ì§€
            self.briefing_text.verticalScrollBar().setValue(
                self.briefing_text.verticalScrollBar().maximum()
            )

    def toggle_qa_view(self):
        """ì§ˆë¬¸-ë‹µë³€ ì˜ì—­ì˜ ë§ˆí¬ë‹¤ìš´ ë·°ì™€ ì¼ë°˜ í…ìŠ¤íŠ¸ ë·° ì „í™˜"""
        if hasattr(self, 'qa_markdown_view'):
            # í…ìŠ¤íŠ¸ â†’ ë§ˆí¬ë‹¤ìš´ ì „í™˜ ë˜ëŠ” ê·¸ ë°˜ëŒ€
            self.qa_markdown_view = not self.qa_markdown_view
            
            if self.qa_markdown_view:
                # í…ìŠ¤íŠ¸ â†’ ë§ˆí¬ë‹¤ìš´ ì „í™˜
                self.qa_toggle_view_button.setText("ğŸ”„ í…ìŠ¤íŠ¸ ë³´ê¸°")
                # ì§ˆë¬¸/ë‹µë³€ ê¸°ë¡ì„ HTMLë¡œ ë Œë”ë§
                self.render_qa_history()
            else:
                # ë§ˆí¬ë‹¤ìš´ â†’ í…ìŠ¤íŠ¸ ì „í™˜
                self.qa_toggle_view_button.setText("ğŸ”„ ë§ˆí¬ë‹¤ìš´ ë³´ê¸°")
                # ì§ˆë¬¸/ë‹µë³€ ê¸°ë¡ì„ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
                plain_text = ""
                for item in self.qa_history_list:
                    if item["type"] == "question":
                        plain_text += f"ì§ˆë¬¸: {item['content']}\n\n"
                    elif item["type"] == "answer":
                        plain_text += f"ë‹µë³€: {item['content']}\n\n"
                    elif item["type"] == "error":
                        plain_text += f"ì˜¤ë¥˜: {item['content']}\n\n"
                
                self.qa_history.setPlainText(plain_text)
        else:
            # ì´ˆê¸°í™”
            self.qa_markdown_view = True
            self.qa_toggle_view_button.setText("ğŸ”„ í…ìŠ¤íŠ¸ ë³´ê¸°")
            self.render_qa_history()
    
    def render_qa_history(self):
        """ì§ˆë¬¸-ë‹µë³€ íˆìŠ¤í† ë¦¬ë¥¼ ë§ˆí¬ë‹¤ìš´/HTMLë¡œ ë Œë”ë§"""
        html_content = """
        <html>
        <head>
        <style>
            body {
                font-family: sans-serif;
                line-height: 1.4;
                color: #2c3e50;
                margin: 0;
                padding: 0;
            }
            .question, .answer, .error, .streaming {
                margin-bottom: 12px;
                padding: 10px;
                border-radius: 5px;
            }
            .question {
                background-color: #f1f8ff;
                border-left: 4px solid #3498db;
            }
            .answer {
                background-color: #f9f9f9;
                border-left: 4px solid #2ecc71;
            }
            .streaming {
                background-color: #f9f9f9;
                border-left: 4px solid #f39c12;
            }
            .error {
                background-color: #fff0f0;
                border-left: 4px solid #e74c3c;
            }
            .result-image {
                max-width: 100%;
                border: 1px solid #ddd;
                border-radius: 5px;
                margin: 10px 0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            h1, h2, h3, h4, h5, h6 {
                margin-top: 16px;
                margin-bottom: 12px;
            }
            p {
                margin-top: 6px;
                margin-bottom: 12px;
            }
            ul, ol {
                margin-top: 6px;
                margin-bottom: 12px;
                padding-left: 2em;
            }
            li {
                margin-bottom: 0.2em;
            }
            pre {
                background-color: #f7f7f7;
                padding: 10px;
                border-radius: 3px;
                overflow-x: auto;
                margin: 10px 0;
            }
            code {
                font-family: monospace;
                background-color: #f0f0f0;
                padding: 2px 4px;
                border-radius: 3px;
            }
        </style>
        </head>
        <body>
        """
        
        for item in self.qa_history_list:
            if item["type"] == "question":
                # ì§ˆë¬¸ HTML ìƒì„±
                html_content += f"""<div class="question"><strong>ì§ˆë¬¸ ({item["timestamp"]}):</strong><br>{item["content"]}</div>"""
            elif item["type"] == "answer":
                # ë§ˆí¬ë‹¤ìš´ ë³€í™˜
                try:
                    answer_html = markdown.markdown(
                        item["content"],
                        extensions=['tables', 'fenced_code', 'codehilite', 'nl2br', 'sane_lists']
                    )
                    html_content += f"""<div class="answer"><strong>ë‹µë³€ ({item["timestamp"]}):</strong><br>{answer_html}</div>"""
                    
                    # ê²°ê³¼ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                    if "result_image" in item and item["result_image"]:
                        html_content += f"""<div class="answer"><strong>ì‹¤í–‰ ê²°ê³¼:</strong><br><img src="{item["result_image"]}" class="result-image" alt="ì‹¤í–‰ ê²°ê³¼"></div>"""
                except Exception as e:
                    # ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
                    formatted_text = item["content"].replace("\n", "<br>")
                    html_content += f"""<div class="answer"><strong>ë‹µë³€ ({item["timestamp"]}):</strong><br>{formatted_text}</div>"""
            elif item["type"] == "streaming":
                # ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ë‹µë³€
                try:
                    streaming_html = markdown.markdown(
                        item["content"],
                        extensions=['tables', 'fenced_code', 'codehilite', 'nl2br', 'sane_lists']
                    )
                    html_content += f"""<div class="streaming"><strong>ë‹µë³€ ì¤‘...</strong><br>{streaming_html}</div>"""
                except Exception as e:
                    # ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì²˜ë¦¬
                    formatted_text = item["content"].replace("\n", "<br>")
                    html_content += f"""<div class="streaming"><strong>ë‹µë³€ ì¤‘...</strong><br>{formatted_text}</div>"""
            elif item["type"] == "error":
                # ì˜¤ë¥˜ ë©”ì‹œì§€
                html_content += f"""<div class="error"><strong>âš ï¸ ì˜¤ë¥˜:</strong> {item["content"]}</div>"""
        
        html_content += """
        </body>
        </html>
        """
        
        # HTML ì„¤ì •
        self.qa_history.setHtml(html_content)

    def handle_generated_code(self, code):
        """ìƒì„±ëœ Python ì½”ë“œ ì²˜ë¦¬ ë° ì‹¤í–‰"""
        self.statusBar.showMessage("ìƒì„±ëœ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ì¤‘...")
        
        # CodeExecutionThread ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì‹¤í–‰
        self.code_exec_thread = CodeExecutionThread(code)
        self.code_exec_thread.execution_completed.connect(self.handle_code_execution_result)
        self.code_exec_thread.start()

    def handle_code_execution_result(self, success, message, result_file):
        """ì½”ë“œ ì‹¤í–‰ ê²°ê³¼ ì²˜ë¦¬"""
        # ë§ˆì§€ë§‰ ì§ˆë¬¸-ë‹µë³€ í•­ëª©ì— ì‹¤í–‰ ê²°ê³¼ ì¶”ê°€
        for i in range(len(self.qa_history_list) - 1, -1, -1):
            if self.qa_history_list[i]["type"] == "answer":
                # ì´ë¯¸ì§€ íŒŒì¼ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°
                if success and result_file:
                    # ê²°ê³¼ íŒŒì¼ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
                    abs_result_file = os.path.abspath(result_file)
                    self.qa_history_list[i]["result_image"] = abs_result_file
                    
                    # í™•ì¥ìì— ë”°ë¥¸ ì²˜ë¦¬
                    file_ext = os.path.splitext(result_file)[1].lower()
                    if file_ext == '.html':
                        # HTML íŒŒì¼ì¸ ê²½ìš° ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
                        self.qa_history_list[i]["content"] += f"\n\n**HTML ì‹œê°í™” ìƒì„±ë¨:** íŒŒì¼ ì—´ê¸° [{os.path.basename(result_file)}]({abs_result_file})"
                        
                        # ì›¹ë¸Œë¼ìš°ì €ë¡œ ê²°ê³¼ íŒŒì¼ ì—´ê¸°
                        try:
                            webbrowser.open(f"file://{abs_result_file}")
                        except Exception as e:
                            print(f"HTML íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: {str(e)}")
                    
                    self.statusBar.showMessage(f"ì½”ë“œ ì‹¤í–‰ ì™„ë£Œ: {os.path.basename(result_file)}")
                else:
                    error_msg = message.replace("\n", "<br>")
                    self.qa_history_list[i]["content"] += f"\n\n**ì½”ë“œ ì‹¤í–‰ ê²°ê³¼:** {message}"
                    self.statusBar.showMessage(f"ì½”ë“œ ì‹¤í–‰ ê²°ê³¼: {message[:50]}...")
                
                # íˆìŠ¤í† ë¦¬ ë‹¤ì‹œ ë Œë”ë§
                self.render_qa_history()
                break

class ChatGPTBriefingThread(QThread):
    """
    ChatGPT APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¸Œë¦¬í•‘ ìƒì„±ì„ ìœ„í•œ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ
    """
    update_signal = pyqtSignal(str)
    finished_signal = pyqtSignal(str)
    error_signal = pyqtSignal(str)
    progress_signal = pyqtSignal(int)
    stream_signal = pyqtSignal(str)  # ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ì„ ìœ„í•œ ì‹œê·¸ë„ ì¶”ê°€

    def __init__(self, layout_file, tmp_briefing_file, model_path, api_key, gpt_model="gpt-4o-2024-11-20", language="korean"):
        QThread.__init__(self)
        self.layout_file = layout_file
        self.tmp_briefing_file = tmp_briefing_file
        self.model_path = model_path  # í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ (ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
        self.api_key = api_key  # ChatGPT API í‚¤
        self.gpt_model = gpt_model  # ChatGPT ëª¨ë¸
        self.language = language
        self.update_interval = 50  # ì—…ë°ì´íŠ¸ ê°„ê²© (ms)
        self.is_generating = False  # ìƒì„± ì§„í–‰ ì¤‘ í”Œë˜ê·¸
        self.progress_timer = None  # ì§„í–‰ íƒ€ì´ë¨¸
        self.current_progress = 0   # í˜„ì¬ ì§„í–‰ë¥ 

    def run(self):
        """
        QA ìŠ¤ë ˆë“œ ì‹¤í–‰ - ë ˆì´ì•„ì›ƒ ë° ë¸Œë¦¬í•‘ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸-ë‹µë³€ ìƒì„±
        
        íŠ¹ë³„ í‚¤ì›Œë“œ "IIFA" ì‚¬ìš©ë²•:
        - ë©”ì‹œì§€ ì‹œì‘ ë˜ëŠ” ëì— "IIFA"ë¥¼ ì¶”ê°€í•˜ë©´ ì‹œê°í™”/ì½”ë“œ ìƒì„± ëª¨ë“œ í™œì„±í™”
        - ê·¸ ì™¸ì˜ ê²½ìš°ì—ëŠ” ì¼ë°˜ ì „ìˆ  ì¡°ì–¸ ëª¨ë“œë¡œ ì‘ë™
        - í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•˜ì§€ ì•ŠìŒ (iifa, IIFA ëª¨ë‘ ì¸ì‹)
        """
        try:
            # ì´ˆê¸°í™” ë‹¨ê³„ - ì§„í–‰ë¥  5%
            self.current_progress = 5
            self.progress_signal.emit(self.current_progress)
            self.update_signal.emit("ë ˆì´ì•„ì›ƒ ë¡œë“œ ì¤‘...")
            
            # ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì‹œì‘
            self.start_progress_timer()
            
            # ë ˆì´ì•„ì›ƒ ë¡œë“œ - ì§„í–‰ë¥  20%
            layout = load_layout_from_file(self.layout_file)
            self.current_progress = 20
            self.progress_signal.emit(self.current_progress)
            
            # ë ˆì´ì•„ì›ƒ ë¶„ì„ - ì§„í–‰ë¥  30%
            self.update_signal.emit("ê³µê°„ ë ˆì´ì•„ì›ƒ ë¶„ì„ ì¤‘...")
            analysis = analyze_layout(layout)
            self.current_progress = 30
            self.progress_signal.emit(self.current_progress)
            
            # ë¸Œë¦¬í•‘ ìƒì„± ì‹œì‘ - ì§„í–‰ë¥  40%ë¶€í„° 95%ê¹Œì§€ ì„œì„œíˆ ì¦ê°€
            self.update_signal.emit("ChatGPTë¡œ ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...")
            self.current_progress = 40
            self.progress_signal.emit(self.current_progress)
            
            # ë¸Œë¦¬í•‘ ìƒì„± ì‹œì‘ì„ í”Œë˜ê·¸ë¡œ í‘œì‹œ
            self.is_generating = True
            
            # ChatGPT API í˜¸ì¶œìš© í”„ë¡¬í”„íŠ¸ ìƒì„±
            layout_str = layout.to_language_string()
            
            # API ìš”ì²­ í—¤ë” ë° URL ì„¤ì •
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.api_key}"
            }
            api_url = "https://api.openai.com/v1/chat/completions"
            
            # ì–¸ì–´ ì„¤ì •
            lang_instruction = ""
            if self.language == "korean":
                lang_instruction = "\n\nì¤‘ìš”: ë‹¹ì‹ ì˜ ì‘ë‹µì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ëª¨ë“  ì œëª©, ìš©ì–´, ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”."
            
            # ê°„ê²°í•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
            system_prompt = f"""ë‹¹ì‹ ì€ 3D ê³µê°„ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ìš”ì•½í•˜ëŠ” ì „ë¬¸ê°€ì´ì êµ°ì‚¬ ì‘ì „ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ê³µê°„ ë ˆì´ì•„ì›ƒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  ë°ì´í„°ì— ê¸°ë°˜í•œ ì „ìˆ ì  ë¸Œë¦¬í•‘ê³¼ ì‘ì „ ê´€ë ¨ ì •ë³´ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. 

ì‘ì „ì„ ìˆ˜í–‰í•˜ëŠ” í˜„ì¥ ìš”ì›ê³¼ ì§€íœ˜ê´€ì—ê²Œ ì „ì¥ ìƒí™©ì„ ì‚¬ì „ì— íŒŒì•…í•˜ê³  íš¨ê³¼ì ì¸ ì‘ì „ ê³„íšì„ ìˆ˜ë¦½í•˜ëŠ” ë° í•„ìˆ˜ì ì¸ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ ë‹¤ìŒì— ì¤‘ì ì„ ë‘ì„¸ìš”:
1. ì¸ê°„ì´ ì¼ë°˜ì ìœ¼ë¡œ íŒŒì•…í•˜ê¸° ì–´ë µê±°ë‚˜ ê°„ê³¼í•˜ê¸° ì‰¬ìš´ ì „ìˆ ì  ìš”ì†Œ
2. ì‘ì „ ìˆ˜í–‰ì— í•µì‹¬ì ì¸ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì¤‘ìš” ì •ë³´
3. ìœ„í—˜ ìš”ì†Œì™€ ê¸°íšŒ ìš”ì†Œë¥¼ ëª…í™•íˆ ì‹ë³„í•˜ëŠ” ë°ì´í„° ê¸°ë°˜ ë¶„ì„
4. í˜„ì¥ ìƒí™©ì—ì„œ ë¹ ë¥´ê²Œ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ” ì •ëŸ‰ì  ë°ì´í„°ì™€ ëª…í™•í•œ ë¶„ì„
5. ì‹œê°ì  ì œí•œì‚¬í•­(ì‚¬ê°ì§€ëŒ€, ë§¹ì )ê³¼ ìŒí–¥ íŠ¹ì„±ì´ ì‘ì „ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
6. ê³µê°„ êµ¬ì¡°ê°€ í†µì‹  ë° ì¥ë¹„ íš¨ìœ¨ì„±ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
7. ê³µê°„ ë‚´ ì´ë™ íŒ¨í„´ ì˜ˆì¸¡ ë° í†µì œ ì§€ì  ì‹ë³„
8. ì¹˜ëª…ì  ê²½ë¡œ ë° ìœ„í—˜ êµ¬ì—­ ì‹ë³„ê³¼ ìš°íšŒ ë°©ë²•


í•­ìƒ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ êµ¬ì¡°í™”í•˜ì„¸ìš”. ê°€ëŠ¥í•œ í•œ ì •í™•í•œ ìˆ˜ì¹˜ ë°ì´í„°ì™€ ê³µê°„ì  íŠ¹ì„±ì„ í¬í•¨í•˜ê³ , ì‹¤ì œ ì‘ì „ì— í™œìš©í•  ìˆ˜ ìˆëŠ” í†µì‹ , ì „ìˆ , ì¥ë¹„ ê´€ë ¨ ì •ë³´ë„ í¬í•¨í•˜ì„¸ìš”. ì„ì˜ë¡œ ë‹µë³€ì„ ì¤‘ë‹¨í•˜ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ëª¨ë“  í•­ëª©ì— ëŒ€í•œ ì™„ì „í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼í•©ë‹ˆë‹¤."""
            
            # ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ìƒì„± (í™•ì¥ëœ ë²„ì „)
            user_prompt = f"""ë‹¤ìŒì€ 3D ê³µê°„ì˜ ìƒì„¸ ë ˆì´ì•„ì›ƒ ì •ë³´ì…ë‹ˆë‹¤:

{layout_str}

ì´ ê³µê°„ì— ëŒ€í•œ ìƒì„¸í•œ ì „ìˆ ì  ë¸Œë¦¬í•‘ê³¼ ì‘ì „ ê³„íšì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ë‹¤ìŒ í•µì‹¬ ì„¹ì…˜ì„ í¬í•¨í•˜ë˜, ì •ëŸ‰ì  ìˆ˜ì¹˜ì™€ ê³µê°„ íŠ¹ì„±ì— ì§‘ì¤‘í•´ì£¼ì„¸ìš”:

## 1. ê°œìš”
- ê³µê°„ ìœ í˜•, ì •í™•í•œ ì¹˜ìˆ˜(ê°€ë¡œ, ì„¸ë¡œ, ë†’ì´), ë©´ì  ë° ì²´ì  ìˆ˜ì¹˜
- ê³µê°„ ë°°ì¹˜ì˜ íŠ¹ì§•ì  íŒ¨í„´ ë° ì¤‘ìš” êµ¬ì¡°ì  íŠ¹ì„±
- ê°€ì¥ ì¤‘ìš”í•œ ì „ìˆ ì  íŠ¹ì„± 5ê°€ì§€ì™€ ê·¸ ì¤‘ìš”ë„ ì ìˆ˜(1-10)
- ì‘ì „ ì„±ê³µì— ê²°ì •ì  ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” í•µì‹¬ ìš”ì†Œ 3ê°€ì§€
- ì¦‰ê°ì ì¸ ì¡°ì¹˜ê°€ í•„ìš”í•œ ìœ„í—˜ ìš”ì†Œ ë° ê¸°íšŒ ìš”ì†Œ

## 2. ê³µê°„ êµ¬ì¡° ë¶„ì„
- ëª¨ë“  ë²½ì²´ì˜ ì •í™•í•œ ìœ„ì¹˜, ì¹˜ìˆ˜, ì¬ì§ˆ ì¶”ì •
- ëª¨ë“  ì¶œì…êµ¬ì™€ ì°½ë¬¸ì˜ ìœ„ì¹˜, í¬ê¸°, ê°œí ë°©í–¥ ë¶„ì„
- êµ¬ì¡°ì  íŠ¹ì´ì ê³¼ ì·¨ì•½ì  ìƒì„¸ í‰ê°€(ìˆ˜ì¹˜ ë°ì´í„° í¬í•¨)
- ì²œì¥ ë° ë°”ë‹¥ êµ¬ì¡°ì˜ íŠ¹ì„±ê³¼ ì „ìˆ ì  ì˜í–¥
- êµ¬ì¡°ë¬¼ ë¶•ê´´ ê°€ëŠ¥ì„± ë° í™”ì¬ í™•ì‚° ê²½ë¡œ ë¶„ì„
- ì•ˆì •ì„±ì´ ì˜ì‹¬ë˜ëŠ” ìš”ì†Œ ë° ëŒ€ì‘ ë°©ì•ˆ

## 3. ì ‘ê·¼ì  ì¢…í•© ë¶„ì„
- ëª¨ë“  ì¶œì…êµ¬ì˜ ìƒì„¸ ëª©ë¡ê³¼ ì ‘ê·¼ ë‚œì´ë„(1-10)
- ê° ì ‘ê·¼ì ì˜ ì¹˜ìˆ˜, ì¬ì§ˆ, êµ¬ì¡°ì  íŠ¹ì„±
- ì£¼ìš” ì ‘ê·¼ ê²½ë¡œì˜ ìœ„í—˜ ìš”ì†Œì™€ ë°©ì–´/ê³µê²© ê°€ëŠ¥ì„± ë¶„ì„
- ì¶œì…êµ¬ ê°„ ìƒê´€ê´€ê³„ ë° ì‹œì„ /ì´ë™ ì—°ê²°ì„± ë§¤íŠ¸ë¦­ìŠ¤
- ì ‘ê·¼ì ë³„ ìµœì  ëŒíŒŒ ë°©ë²• ë° í•„ìš” ì¥ë¹„
- ê° ì¶œì…êµ¬ì˜ ìŒí–¥ íŠ¹ì„±(ì†Œë¦¬ ì „ë‹¬ ê³„ìˆ˜)
- ì™¸ë¶€ ì—°ê²° ì°½ë¬¸/ë¬¸ì— ëŒ€í•œ ëŒ€ì €ê²©ìˆ˜ ê³ ë ¤ì‚¬í•­

## 4. ì´ë™ ë° ì‹œì•¼ ë¶„ì„
- ì£¼ìš” ì´ë™ ê²½ë¡œì˜ ì •í™•í•œ ê¸¸ì´, í­, ë†’ì´
- ëª¨ë“  êµ¬ì—­ ê°„ ìµœë‹¨ ê²½ë¡œì™€ ì†Œìš” ì‹œê°„ ì˜ˆì¸¡(ì´ˆ ë‹¨ìœ„)
- ì‹œì•¼ ë¶„ì„: ê° ì£¼ìš” ì§€ì ì—ì„œì˜ ê°€ì‹œ ë²”ìœ„ì™€ ê°ë„(ë„ ë‹¨ìœ„)
- ë§¹ì , ì‚¬ê°ì§€ëŒ€, ë³‘ëª©ì§€ì ì˜ ì •í™•í•œ ìœ„ì¹˜ì™€ í¬ê¸°
- ê³µê°„ ë‚´ ì´ë™ íŒ¨í„´ ì˜ˆì¸¡ ë° í†µì œ ì§€ì  ì‹ë³„
- ì¹˜ëª…ì  ê²½ë¡œ ë° ìœ„í—˜ êµ¬ì—­ ì‹ë³„ê³¼ ìš°íšŒ ë°©ë²•
- ì†Œë¦¬ ì „íŒŒ íŠ¹ì„±ê³¼ ê°ì§€ í™•ë¥  ë¶„ì„
- ë°© ì²­ì†Œ ìˆœì„œ ë° íŒ€ ë°°ì¹˜ ê¶Œì¥ì‚¬í•­
- ì´ë™ í…œí¬ ë¶„ì„(ê³µê°„ ì œì•½ì— ë”°ë¥¸ ì†ë„ ë³€í™” ê¶Œì¥)
- ì§„ì… ì˜µì…˜(ê°•ì œ/ë¹„ê°•ì œ)ê³¼ ì„±ê³µ í™•ë¥ 

## 5. ë¬¼ì²´ ë° ì¥ì• ë¬¼ ë¶„ì„
- ëª¨ë“  ì£¼ìš” ë¬¼ì²´ì˜ ì •í™•í•œ ìœ„ì¹˜, ì¹˜ìˆ˜, ì¬ì§ˆ ì¶”ì •
- ì¥ì• ë¬¼ íŠ¹ì„±ì— ë”°ë¥¸ ë°©ì–´ ë“±ê¸‰ í‰ê°€(1-10)
- ì—„íë¬¼ì˜ íš¨ê³¼ì ì¸ ë°©ì–´ ë²”ìœ„ì™€ ì‹œê°„(íƒ„ì¢…ë³„ ê´€í†µ ì €í•­ í¬í•¨)
- ë¬¼ì²´ ë°°ì¹˜ íŒ¨í„´ê³¼ ê³µê°„ í™œìš© íš¨ìœ¨ì„± ë¶„ì„
- ê° ë¬¼ì²´ì˜ íƒ„ë„í•™ì  ë³´í˜¸ ë“±ê¸‰(ë ˆë²¨ I-IV ìƒë‹¹)
- ë‹¤ì–‘í•œ ê°ë„ì—ì„œì˜ ì€í ì˜µì…˜ê³¼ ê°ì§€ í™•ë¥ 
- ê° ì—„íë¬¼ ìœ„ì¹˜ì—ì„œì˜ 360Â° í™”ë ¥ ë¶„ì„
- ë¬¼ì²´ì˜ ì•ˆì •ì„± ë¶„ì„(íŒŒê´´ ì‹œ 2ì°¨ ìœ„í—˜ ìš”ì†Œ)

## 6. ì „ìˆ ì  ìœ„ì¹˜ í‰ê°€
- ìµœì ì˜ ë°©ì–´/ê³µê²© ìœ„ì¹˜ ì¢Œí‘œì™€ ê° ìœ„ì¹˜ì˜ ê°•ì /ì•½ì 
- ê° ìœ„ì¹˜ì—ì„œì˜ í†µì œ ê°€ëŠ¥ ì˜ì—­ ë¹„ìœ¨ê³¼ ì‚¬ê°ì§€ëŒ€
- ìœ„í—˜ë„ íˆíŠ¸ë§µ(ê³µê°„ì˜ ê° êµ¬ì—­ë³„ ë…¸ì¶œ ìˆ˜ì¤€ ìˆ˜ì¹˜í™”)
- ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í†µì œ ì§€ì ì˜ ì •í™•í•œ ì¢Œí‘œì™€ ì¤‘ìš”ë„
- ê° ì  ìœ„ì¹˜ì— ëŒ€í•œ ëŒ€ì‘ ìœ„ì¹˜ ë¶„ì„
- ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ë° ê°€ì¥ ìœ„í—˜í•œ ì  í–‰ë™ ê³¼ì • í‰ê°€
- ì •í™•í•œ ìœ„ì¹˜ ì¢Œí‘œì™€ íŒ€ êµ¬ì„±ì„ í¬í•¨í•œ ìƒì„¸ ë³‘ë ¥ ë°°ì¹˜
- ìµœëŒ€ ì§€ì› ê°€ëŠ¥ ì¸ì›ê³¼ í•œê³„ ë¶„ì„
- íŠ¹ìˆ˜ ë¬´ê¸° ìœ„ì¹˜ ê¶Œì¥ì‚¬í•­(ì§€ì • ì‚¬ìˆ˜, ì¡°ì¤€ì‚¬ê²© ë“±)

## 7. í™˜ê²½ ë° ìì› ë¶„ì„ [ë§¤ìš° ìƒì„¸í•˜ê²Œ ì‘ì„±]
- ì¡°ëª… ì¡°ê±´ ë¶„ì„ ë° ëª…ì•” ëŒ€ë¹„ ì§€ì  ì‹ë³„(ì£¼/ì•¼ê°„ ì°¨ì´ í¬í•¨)
- ìŒí–¥ íŠ¹ì„± í‰ê°€(ì†Œë¦¬ ì „íŒŒ íŒ¨í„´, ìš¸ë¦¼, ì°¨í)
- ìµœì  ì¥ë¹„ ë°°ì¹˜ ì¢Œí‘œì™€ ì¸ì› ë°°ì¹˜ ì œì•ˆ(ì •í™•í•œ ì¸ì›ìˆ˜ ë° ìœ„ì¹˜)
- ê³µê°„ íŠ¹ì„±ì— ë”°ë¥¸ íŠ¹ìˆ˜ ì¥ë¹„ ìš”êµ¬ì‚¬í•­ ë° íš¨ê³¼ ì˜ˆì¸¡
- ì˜¨ë„, ìŠµë„, í™˜ê¸° ë“± í™˜ê²½ ì¡°ê±´ì´ ì‘ì „ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
- ìì—°ê´‘/ì¸ê³µì¡°ëª… íŠ¹ì„±ê³¼ ì‘ì „ ì‹œê°„ëŒ€ë³„ ì‹œì•¼ ì¡°ê±´ ë³€í™”
- ë°”ë‹¥ ì¬ì§ˆê³¼ ì†ŒìŒ ë°œìƒ ê´€ê³„ ë¶„ì„
- ê°ì§€ë  ìˆ˜ ìˆëŠ” ê³µê°„ ë‚´ ë‹¤ì–‘í•œ ê°ê° ì •ë³´(ëƒ„ìƒˆ, ì§„ë™ ë“±)

## 8. í†µì‹  ì²´ê³„ ê³„íš 
- ê³µê°„ ë‚´ ë¬´ì„  í†µì‹  íš¨ìœ¨ì„± ë° ì°¨í êµ¬ì—­ ë¶„ì„
- ìµœì ì˜ í†µì‹  ì¤‘ê³„ ìœ„ì¹˜ ë° í†µì‹  ì¥ë¹„ ì„¤ì • ì œì•ˆ
- í†µì‹  ë‘ì ˆ êµ¬ì—­ ë° ë¹„ìƒ í†µì‹  í”„ë¡œí† ì½œ
- ì‹ í˜¸ ê°„ì„­ ë° ë°©í•´ ê°€ëŠ¥ì„± í‰ê°€(1-10)
- ê° ìœ„ì¹˜ë³„ í†µì‹  í’ˆì§ˆ ë“±ê¸‰ ì§€ì •(1-10)
- ë¬¼ë¦¬ì  ë°©í•´ë¬¼ì— ì˜í•œ í†µì‹  ì¥ì•  ì˜ˆìƒ ì§€ì 
- ì£¼íŒŒìˆ˜ ë° í†µì‹  ë°©ì‹ ê¶Œì¥ì‚¬í•­(íŠ¹ì • í†µì‹  ì¥ë¹„ ì¶”ì²œ)
- ì¥ë¹„ë³„ ì‹ í˜¸ ê°ì‡  ìˆ˜ì¤€ê³¼ ìµœëŒ€ ì‘ë™ ê±°ë¦¬ ê³„ì‚°
- ì‹ í˜¸ ë³´ì•ˆ ë° ë„ì²­ ìœ„í—˜ì„± í‰ê°€

## 9. ì‘ì „ ì „ìˆ  ë° ì ˆì°¨ 
- ê³µê°„ë³„ ê¶Œì¥ ì‘ì „ ì „ìˆ  ë° ê¸°ë™ ë°©ì‹
- íŒ€ êµ¬ì„± ë° ì—­í•  ë¶„ë‹´ ì œì•ˆ(ì¸ì›ë³„ ì„ë¬´ì™€ ìœ„ì¹˜)
- ë‹¨ê³„ë³„ ì‘ì „ ìˆ˜í–‰ íƒ€ì„ë¼ì¸ ë° ì¡°ì •ì 
- ì˜ˆìƒ ì‹œë‚˜ë¦¬ì˜¤ë³„ ëŒ€ì‘ ê³„íš ë° ìš°ë°œìƒí™© ëŒ€ë¹„ì±…
- ì‘ì „ ì„±ê³µë¥  ë° ìœ„í—˜ë„ ê³„ì‚°(ì •ëŸ‰ì  ìˆ˜ì¹˜)
- ì‹œê°„ëŒ€ë³„ ì‘ì „ ìˆ˜í–‰ ì¡°ê±´ ë° ëŒ€ì‘ ë°©ì•ˆ
- íŠ¹ìˆ˜ ìƒí™©(ì¸ì§ˆ, ë¯¼ê°„ì¸, í­ë°œë¬¼ ë“±) ëŒ€ì‘ í”„ë¡œí† ì½œ
- ë³‘ë ¥ ë¶„ì‚°ê³¼ ì§‘ì¤‘ì— ê´€í•œ ì „ìˆ  ì œì•ˆ
- ì •ë°€í•œ ì‹œê°„-ì´ë™ ëª¨ë¸ ê¸°ë°˜ì˜ ì‘ì „ í…œí¬ ë¶„ì„
- ìƒí™©ë³„ ìš°ì„ ìˆœìœ„ì™€ ê²°ì • ì§€ì  ëª…ì‹œ

## 10. ì¥ë¹„ ë° ë¬´ê¸° ì¶”ì²œ 
- ê³µê°„ íŠ¹ì„±ì— ìµœì í™”ëœ ë¬´ê¸° ë° ì¥ë¹„ ì„¸íŠ¸
- ì£¼ìš” ìœ„ì¹˜ë³„ ê¶Œì¥ í™”ê¸° ìœ í˜• ë° íƒ„ì•½ ì¢…ë¥˜
- íŠ¹ìˆ˜ ì¥ë¹„ í•„ìš”ì„± ë° íš¨ê³¼ ë¶„ì„(ì—´í™”ìƒ, ì•¼ê°„ íˆ¬ì‹œ, ë°©íƒ„ ë“±)
- ì¥ë¹„ë³„ íš¨ìœ¨ì„± í‰ê°€ ë° ìš°ì„ ìˆœìœ„(1-10)
- ìœ íš¨ ì‚¬ê±°ë¦¬ì™€ ê³µê°„ ì¹˜ìˆ˜ ê¸°ë°˜ ë¬´ê¸° ì„ íƒ ê·¼ê±°
- í•„ìˆ˜ ë°©í˜¸ ì¥ë¹„ ë° ì¥ë¹„ë³„ ì´ë™ì„±-ë³´í˜¸ ê· í˜•ì 
- êµ¬ì²´ì ì¸ í™”ê¸° ëª¨ë¸ ë° ì ‘ê·¼ë²•ë³„ ì¶”ì²œ ë¶€ì°©ë¬¼
- íŠ¹ìˆ˜ ìƒí™©ë³„ í•„ìš” ì¥ë¹„ ë° íš¨ìœ¨ì„± í‰ê°€
- ì¥ë¹„ ì¤‘ëŸ‰ê³¼ ì´ë™ì„± ê°„ì˜ ìƒê´€ê´€ê³„ ë¶„ì„

## 11. ì¢…í•© ì „ìˆ  í‰ê°€ [ê°€ì¥ ìƒì„¸í•˜ê²Œ ì‘ì„±]
- ì „ì²´ ê³µê°„ì˜ ë°©ì–´ ë‚œì´ë„ ë° ê³µê²© ìš©ì´ì„± ì ìˆ˜(1-10)
- ì£¼ìš” ì „ìˆ ì  ì¥ë‹¨ì ì˜ ì •ëŸ‰ì  í‰ê°€
- ê³µê°„ í™œìš©ì„ ìœ„í•œ ìµœì í™” ì œì•ˆê³¼ ì˜ˆìƒ íš¨ê³¼
- íŠ¹ì´ì‚¬í•­ ë° íŠ¹ë³„ ê³ ë ¤ì‚¬í•­(ì •ëŸ‰ì  ë°ì´í„° ê¸°ë°˜)
- ì‘ì „ ìˆ˜í–‰ ì‹œ ê³ ë ¤í•´ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•œ ìš”ì†Œ 5ê°€ì§€
- ê° ì ‘ê·¼ë²•ë³„ ì„±ê³µ í™•ë¥ ê³¼ ìœ„í—˜ë„ ìƒì„¸ ë¶„ì„
- ê³µê°„ë³„ ì „ìˆ  ìš°ì„ ìˆœìœ„ì™€ ìì› ë°°ë¶„ ê¶Œì¥ì‚¬í•­
- ìµœì ì˜ ì‘ì „ ìˆ˜í–‰ ë°©ì‹ì— ëŒ€í•œ ì¢…í•©ì  ì œì•ˆ
- ì‹œë®¬ë ˆì´ì…˜ ê¸°ë°˜ ìµœì  ì‘ì „ ê²½ë¡œì™€ íƒ€ì„ë¼ì¸
- ì¸ëª… ìœ„í—˜ì„ ìµœì†Œí™”í•˜ëŠ” ì´ë™ ë° ì‘ì „ íŒ¨í„´ ì œì•ˆ

ëª¨ë“  ì„¹ì…˜ì€ ë™ì¼í•œ ìˆ˜ì¤€ì˜ ìƒì„¸ë„ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. íŠ¹íˆ í›„ë°˜ë¶€ ì„¹ì…˜(6-11)ì€ ì•ë¶€ë¶„ê³¼ ë™ì¼í•˜ê±°ë‚˜ ë” ë†’ì€ ìˆ˜ì¤€ì˜ ìƒì„¸í•¨ê³¼ êµ¬ì²´ì ì¸ ì •ë³´ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ê° ì„¹ì…˜ì—ëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
- ì¼ë°˜ì ì¸ ì„¤ëª…ë³´ë‹¤ëŠ” ì •ëŸ‰ì  ë°ì´í„°ì™€ êµ¬ì²´ì  ìˆ˜ì¹˜ ì¤‘ì‹¬ì˜ ë¶„ì„
- ê³µê°„ë³„, ìƒí™©ë³„ ì°¨ë³„í™”ëœ ì „ìˆ ì  ì ‘ê·¼ë²•
- ì¸ê³µì§€ëŠ¥ ê´€ì ì—ì„œ ë°œê²¬í•œ ì¼ë°˜ ì‚¬ëŒì´ ë†“ì¹˜ê¸° ì‰¬ìš´ ê³µê°„ì  íŠ¹ì„±ê³¼ ê·¸ ì˜ë¯¸
- ìœ ì‚¬í•œ ì‘ì „ í™˜ê²½ì—ì„œì˜ ê³¼ê±° ê²½í—˜ê³¼ êµí›ˆì— ê¸°ë°˜í•œ ì‹¤ìš©ì  ì¡°ì–¸
- ê° ìš”ì†Œì˜ ì¤‘ìš”ë„ì™€ ì˜í–¥ë ¥ì— ëŒ€í•œ ëª…í™•í•œ í‰ê°€(1-10 ì²™ë„)

í•­ìƒ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ êµ¬ì¡°í™”í•˜ê³ , ê° ì„¹ì…˜ë§ˆë‹¤ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ì™€ ì „ë¬¸ê°€ ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”. íŠ¹íˆ í•µì‹¬ ê²°ì • ì‚¬í•­ê³¼ ìƒëª…ì„ ìœ„í˜‘í•  ìˆ˜ ìˆëŠ” ìš”ì†Œë“¤ì„ ê°•ì¡° í‘œì‹œí•˜ì—¬ ì‹ ì†í•œ ì°¸ì¡°ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•˜ì„¸ìš”.

"""
            
            # ë©”ì‹œì§€ êµ¬ì„±
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
            
            # API ìš”ì²­ ë³¸ë¬¸ êµ¬ì„± - ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í™œì„±í™”
            request_body = {
                "model": self.gpt_model,
                "messages": messages,
                "temperature": 0.5,  # ë” ì¼ê´€ëœ ê²°ê³¼ë¥¼ ìœ„í•´ ë‚®ì€ temperature
                "max_tokens": 15000,   # ë§¤ìš° ìƒì„¸í•œ ë¸Œë¦¬í•‘ì„ ìœ„í•´ í† í° ìˆ˜ ì¦ê°€
                "top_p": 0.95,
                "frequency_penalty": 0,
                "presence_penalty": 0.1,  # ì•½ê°„ì˜ ë‹¤ì–‘ì„± ì¶”ê°€
                "stream": True  # ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í™œì„±í™”
            }
            
            # ì „ì²´ ì‘ë‹µì„ ì €ì¥í•  ë³€ìˆ˜
            full_response = ""
            self.update_signal.emit("ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...")
            
            # API ìš”ì²­ ì „ì†¡ (ìŠ¤íŠ¸ë¦¬ë°)
            with requests.post(
                api_url,
                headers=headers,
                json=request_body,
                timeout=300,  # íƒ€ì„ì•„ì›ƒ 300ì´ˆ
                stream=True  # ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ
            ) as response:
                
                if response.status_code == 200:
                    for line in response.iter_lines():
                        if line:
                            line_text = line.decode('utf-8')
                            
                            # "data: " ì ‘ë‘ì‚¬ ì²˜ë¦¬
                            if line_text.startswith("data: "):
                                line_text = line_text[6:]  # "data: " ì œê±°
                            
                            # ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ ë©”ì‹œì§€ í™•ì¸
                            if line_text == "[DONE]":
                                break
                                
                            try:
                                # JSON íŒŒì‹±
                                json_data = json.loads(line_text)
                                
                                # ë¸íƒ€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                                if "choices" in json_data and json_data["choices"]:
                                    delta = json_data["choices"][0].get("delta", {})
                                    
                                    if "content" in delta:
                                        content = delta["content"]
                                        full_response += content
                                        # ì‹¤ì‹œê°„ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë° ì‹œê·¸ë„ ë°œìƒ
                                        self.stream_signal.emit(content)
                                        # ìƒì„± ë‚´ìš© ì¼ë¶€ í‘œì‹œ
                                        if len(content.strip()) > 0 and len(full_response) % 50 == 0:
                                            self.update_signal.emit(f"ë¸Œë¦¬í•‘ ìƒì„± ì¤‘... {len(full_response)} ê¸€ì ìƒì„±ë¨")
                            except json.JSONDecodeError:
                                # JSON ë””ì½”ë”© ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
                                continue
                    
                    # ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš° í´ë°± ë¸Œë¦¬í•‘ ìƒì„±
                    if not full_response.strip():
                        self.update_signal.emit("ChatGPT ì‘ë‹µì´ ë¹„ì–´ìˆì–´ ê¸°ë³¸ ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...")
                        full_response = generate_tactical_fallback_briefing(analysis, self.language)
                    
                    # ìƒì„± ì™„ë£Œ í‘œì‹œ
                    self.is_generating = False
                    self.current_progress = 95
                    self.progress_signal.emit(self.current_progress)
                    
                    # ê²°ê³¼ ì €ì¥
                    with open(self.tmp_briefing_file, "w", encoding="utf-8") as f:
                        f.write(full_response)
                    
                    # ì§„í–‰ë¥  íƒ€ì´ë¨¸ ì¤‘ì§€
                    self.stop_progress_timer()
                    
                    # ì™„ë£Œ ì‹ í˜¸ ë°œìƒ
                    self.current_progress = 100
                    self.progress_signal.emit(self.current_progress)
                    self.finished_signal.emit(full_response)
                else:
                    error_msg = f"ChatGPT API ì˜¤ë¥˜ (ì½”ë“œ {response.status_code}): {response.text}"
                    self.error_signal.emit(error_msg)
                    # API ì˜¤ë¥˜ ì‹œ í´ë°± ë¸Œë¦¬í•‘ ìƒì„±
                    fallback_briefing = generate_tactical_fallback_briefing(analysis, self.language)
                    self.finished_signal.emit(fallback_briefing)
            
        except Exception as e:
            # ì˜¤ë¥˜ ë°œìƒ ì‹œ íƒ€ì´ë¨¸ ì¤‘ì§€
            self.stop_progress_timer()
            
            self.error_signal.emit(f"ë¸Œë¦¬í•‘ ìƒì„± ì˜¤ë¥˜: {str(e)}")
            import traceback
            traceback.print_exc()
    
    def start_progress_timer(self):
        """ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì‹œì‘"""
        self.progress_timer = QTimer()
        self.progress_timer.timeout.connect(self.update_progress_gradually)
        self.progress_timer.start(300)  # 300ms ê°„ê²©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    
    def stop_progress_timer(self):
        """ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì¤‘ì§€"""
        if self.progress_timer and self.progress_timer.isActive():
            self.progress_timer.stop()
    
    def update_progress_gradually(self):
        """ë¸Œë¦¬í•‘ ìƒì„± ì¤‘ì— ì§„í–‰ë¥ ì„ ì„œì„œíˆ ì¦ê°€ì‹œí‚´"""
        if self.is_generating and self.current_progress < 95:
            # 40% ~ 95% ì‚¬ì´ì—ì„œ ì„œì„œíˆ ì¦ê°€
            increment = max(0.2, min(0.5, (95 - self.current_progress) / 90))
            self.current_progress = min(95, self.current_progress + increment)
            self.progress_signal.emit(int(self.current_progress))

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    parser = argparse.ArgumentParser(description="RRD Viewer with Briefing Popup - Modern UI")
    parser.add_argument("-i", "--input", type=str, help="ì…ë ¥ RRD íŒŒì¼ ê²½ë¡œ (ì´ì „ ë²„ì „ í˜¸í™˜ìš©)")
    parser.add_argument("-r", "--rrd", type=str, help="ì…ë ¥ RRD íŒŒì¼ ê²½ë¡œ")
    parser.add_argument("-l", "--layout", type=str, help="ë ˆì´ì•„ì›ƒ íŒŒì¼ ê²½ë¡œ (.txt)")
    parser.add_argument("-b", "--briefing", type=str, help="ë¸Œë¦¬í•‘ íŒŒì¼ ê²½ë¡œ (.txt)")
    parser.add_argument("-m", "--model", type=str, default="manycore-research/SpatialLM-Llama-1B", 
                        help="SpatialLM ëª¨ë¸ ê²½ë¡œ")
    parser.add_argument("-g", "--language", type=str, default="korean", choices=["english", "korean"],
                        help="ë¸Œë¦¬í•‘ ì–¸ì–´ (english/korean)")
    
    args = parser.parse_args()
    
    # -i ë˜ëŠ” -r ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ í•„ìš”
    rrd_file = args.rrd if args.rrd else args.input
    if not rrd_file:
        print("ì˜¤ë¥˜: RRD íŒŒì¼ ê²½ë¡œê°€ í•„ìš”í•©ë‹ˆë‹¤. -r ë˜ëŠ” -i ì˜µì…˜ì„ ì‚¬ìš©í•˜ì„¸ìš”.")
        parser.print_help()
        sys.exit(1)
    
    # ì…ë ¥ íŒŒì¼ í™•ì¸
    if not os.path.exists(rrd_file):
        print(f"ì˜¤ë¥˜: ì…ë ¥ íŒŒì¼ '{rrd_file}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        sys.exit(1)
    
    # RRD íŒŒì¼ í™•ì¸ - í™•ì¥ìê°€ ì—†ì–´ë„ ê´œì°®ìŒ
    if not rrd_file.lower().endswith('.rrd'):
        print(f"ê²½ê³ : íŒŒì¼ '{rrd_file}'ì€ .rrd í™•ì¥ìê°€ ì•„ë‹™ë‹ˆë‹¤. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
    
    # QApplication ìƒì„±
    app = QApplication(sys.argv)
    
    # ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
    app.setStyle('Fusion')
    
    # ë¸Œë¦¬í•‘ ë·°ì–´ ìƒì„±
    viewer = BriefingViewer(
        rrd_file=rrd_file, 
        model_path=args.model, 
        language=args.language,
        layout_file=args.layout,
        briefing_file=args.briefing
    )
    
    # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
    sys.exit(app.exec_())

if __name__ == "__main__":
    main() 

